(function(a,b){if(typeof define==="function"&&define.amd){define("simple-module",["jquery"],function(c){return(a.Module=b(c))})}else{if(typeof exports==="object"){module.exports=b(require("jquery"))}else{a.SimpleModule=b(jQuery)}}}(this,function(b){var a,c=[].slice;a=(function(){d.extend=function(g){var e,f,h;if(!((g!=null)&&typeof g==="object")){return}for(e in g){h=g[e];if(e!=="included"&&e!=="extended"){this[e]=h}}return(f=g.extended)!=null?f.call(this):void 0};d.include=function(g){var e,f,h;if(!((g!=null)&&typeof g==="object")){return}for(e in g){h=g[e];if(e!=="included"&&e!=="extended"){this.prototype[e]=h}}return(f=g.included)!=null?f.call(this):void 0};d.connect=function(e){if(typeof e!=="function"){return}if(!e.pluginName){throw new Error("Module.connect: cannot connect plugin without pluginName");return}e.prototype._connected=true;if(!this._connectedClasses){this._connectedClasses=[]}this._connectedClasses.push(e);if(e.pluginName){return this[e.pluginName]=e}};d.prototype.opts={};function d(k){var l,g,j,f,m,e,h;this.opts=b.extend({},this.opts,k);(l=this.constructor)._connectedClasses||(l._connectedClasses=[]);m=(function(){var p,n,q,o;q=this.constructor._connectedClasses;o=[];for(p=0,n=q.length;p<n;p++){g=q[p];h=g.pluginName.charAt(0).toLowerCase()+g.pluginName.slice(1);if(g.prototype._connected){g.prototype._module=this}o.push(this[h]=new g())}return o}).call(this);if(this._connected){this.opts=b.extend({},this.opts,this._module.opts)}else{this._init();for(j=0,e=m.length;j<e;j++){f=m[j];if(typeof f._init==="function"){f._init()}}}this.trigger("initialized")}d.prototype._init=function(){};d.prototype.on=function(){var e,f;e=1<=arguments.length?c.call(arguments,0):[];(f=b(this)).on.apply(f,e);return this};d.prototype.one=function(){var e,f;e=1<=arguments.length?c.call(arguments,0):[];(f=b(this)).one.apply(f,e);return this};d.prototype.off=function(){var e,f;e=1<=arguments.length?c.call(arguments,0):[];(f=b(this)).off.apply(f,e);return this};d.prototype.trigger=function(){var e,f;e=1<=arguments.length?c.call(arguments,0):[];(f=b(this)).trigger.apply(f,e);return this};d.prototype.triggerHandler=function(){var e,f;e=1<=arguments.length?c.call(arguments,0):[];return(f=b(this)).triggerHandler.apply(f,e)};d.prototype._t=function(){var e,f;e=1<=arguments.length?c.call(arguments,0):[];return(f=this.constructor)._t.apply(f,e)};d._t=function(){var f,g,h,e;g=arguments[0],f=2<=arguments.length?c.call(arguments,1):[];e=((h=this.i18n[this.locale])!=null?h[g]:void 0)||"";if(!(f.length>0)){return e}e=e.replace(/([^%]|^)%(?:(\d+)\$)?s/g,function(k,j,i){if(i){return j+f[parseInt(i)-1]}else{return j+f.shift()}});return e.replace(/%%s/g,"%s")};d.i18n={"zh-CN":{}};d.locale="zh-CN";return d})();return a}));(function(a,b){if(typeof define==="function"&&define.amd){define("simple-hotkeys",["jquery","simple-module"],function(d,c){return(a.hotkeys=b(d,c))})}else{if(typeof exports==="object"){module.exports=b(require("jquery"),require("simple-module"))}else{a.simple=a.simple||{};a.simple.hotkeys=b(jQuery,SimpleModule)}}}(this,function(e,c){var b,d,f=function(j,h){for(var g in h){if(a.call(h,g)){j[g]=h[g]}}function i(){this.constructor=j}i.prototype=h.prototype;j.prototype=new i();j.__super__=h.prototype;return j},a={}.hasOwnProperty;b=(function(h){f(g,h);function g(){return g.__super__.constructor.apply(this,arguments)}g.count=0;g.keyNameMap={8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",91:"Meta",93:"Meta",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"Multiply",107:"Add",109:"Subtract",110:"Decimal",111:"Divide",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",59:";",61:"=",186:";",187:"=",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};g.aliases={escape:"esc","delete":"del","return":"enter",ctrl:"control",space:"spacebar",ins:"insert",cmd:"meta",command:"meta",wins:"meta",windows:"meta"};g.normalize=function(l){var o,m,n,q,p,k;p=l.toLowerCase().replace(/\s+/gi,"").split("+");for(o=m=0,k=p.length;m<k;o=++m){n=p[o];p[o]=this.aliases[n]||n}q=p.pop();p.sort().push(q);return p.join("_")};g.prototype.opts={el:document};g.prototype._init=function(){this.id=++this.constructor.count;this._map={};this._delegate=typeof this.opts.el==="string"?document:this.opts.el;return e(this._delegate).on("keydown.simple-hotkeys-"+this.id,this.opts.el,(function(i){return function(k){var j;return(j=i._getHander(k))!=null?j.call(i,k):void 0}})(this))};g.prototype._getHander=function(k){var j,i;if(!(j=this.constructor.keyNameMap[k.which])){return}i="";if(k.altKey){i+="alt_"}if(k.ctrlKey){i+="control_"}if(k.metaKey){i+="meta_"}if(k.shiftKey){i+="shift_"}i+=j.toLowerCase();return this._map[i]};g.prototype.respondTo=function(i){if(typeof i==="string"){return this._map[this.constructor.normalize(i)]!=null}else{return this._getHander(i)!=null}};g.prototype.add=function(i,j){this._map[this.constructor.normalize(i)]=j;return this};g.prototype.remove=function(i){delete this._map[this.constructor.normalize(i)];return this};g.prototype.destroy=function(){e(this._delegate).off(".simple-hotkeys-"+this.id);this._map={};return this};return g})(c);d=function(g){return new b(g)};return d}));(function(a,b){if(typeof define==="function"&&define.amd){define("simditor",["jquery","simple-module","simple-hotkeys","simple-uploader","dompurify"],function(g,d,c,f,e){return(a.Simditor=b(g,d,c,f,e))})}else{if(typeof exports==="object"){module.exports=b(require("jquery"),require("simple-module"),require("simple-hotkeys"),require("simple-uploader"),require("dompurify"))}else{a.Simditor=b(jQuery,SimpleModule,simple.hotkeys,simple.uploader,window.DOMPurify)}}}(this,function(B,i,j,P,F){var c,A,y,L,o,g,r,h,b,x,J,Q,u,O,N,t,v,H,k,K,D,s,C,z,E,M,I,f,w,m,q,e,G,a,l=function(U,S){for(var R in S){if(d.call(S,R)){U[R]=S[R]}}function T(){this.constructor=U}T.prototype=S.prototype;U.prototype=new T();U.__super__=S.prototype;return U},d={}.hasOwnProperty,p=[].indexOf||function(T){for(var S=0,R=this.length;S<R;S++){if(S in this&&this[S]===T){return S}}return -1},n=[].slice;E=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.pluginName="Selection";R.prototype._range=null;R.prototype._startNodes=null;R.prototype._endNodes=null;R.prototype._containerNode=null;R.prototype._nodes=null;R.prototype._blockNodes=null;R.prototype._rootNodes=null;R.prototype._init=function(){this.editor=this._module;this._selection=document.getSelection();this.editor.on("selectionchanged",(function(T){return function(U){T.reset();return T._range=T._selection.getRangeAt(0)}})(this));this.editor.on("blur",(function(T){return function(U){return T.reset()}})(this));return this.editor.on("focus",(function(T){return function(U){T.reset();return T._range=T._selection.getRangeAt(0)}})(this))};R.prototype.reset=function(){this._range=null;this._startNodes=null;this._endNodes=null;this._containerNode=null;this._nodes=null;this._blockNodes=null;return this._rootNodes=null};R.prototype.clear=function(){var T;try{this._selection.removeAllRanges()}catch(U){T=U}return this.reset()};R.prototype.range=function(T){var U;if(T){this.clear();this._selection.addRange(T);this._range=T;U=this.editor.util.browser.firefox||this.editor.util.browser.msie;if(!this.editor.inputManager.focused&&U){this.editor.body.focus()}}else{if(!this._range&&this.editor.inputManager.focused&&this._selection.rangeCount){this._range=this._selection.getRangeAt(0)}}return this._range};R.prototype.startNodes=function(){if(this._range){this._startNodes||(this._startNodes=(function(T){return function(){var U;U=B(T._range.startContainer).parentsUntil(T.editor.body).get();U.unshift(T._range.startContainer);return B(U)}})(this)())}return this._startNodes};R.prototype.endNodes=function(){var T;if(this._range){this._endNodes||(this._endNodes=this._range.collapsed?this.startNodes():(T=B(this._range.endContainer).parentsUntil(this.editor.body).get(),T.unshift(this._range.endContainer),B(T)))}return this._endNodes};R.prototype.containerNode=function(){if(this._range){this._containerNode||(this._containerNode=B(this._range.commonAncestorContainer))}return this._containerNode};R.prototype.nodes=function(){if(this._range){this._nodes||(this._nodes=(function(T){return function(){var U;U=[];if(T.startNodes().first().is(T.endNodes().first())){U=T.startNodes().get()}else{T.startNodes().each(function(Y,X){var ac,W,V,Z,aa,ad,ab;W=B(X);if(T.endNodes().index(W)>-1){return U.push(X)}else{if(W.parent().is(T.editor.body)||(ad=T.endNodes().index(W.parent()))>-1){if(ad&&ad>-1){ac=T.endNodes().eq(ad-1)}else{ac=T.endNodes().last()}V=W.parent().contents();ab=V.index(W);Z=V.index(ac);return B.merge(U,V.slice(ab,Z).get())}else{V=W.parent().contents();aa=V.index(W);return B.merge(U,V.slice(aa).get())}}});T.endNodes().each(function(X,Y){var V,Z,W;V=B(Y);if(V.parent().is(T.editor.body)||T.startNodes().index(V.parent())>-1){U.push(Y);return false}else{Z=V.parent().contents();W=Z.index(V);return B.merge(U,Z.slice(0,W+1))}})}return B(B.unique(U))}})(this)())}return this._nodes};R.prototype.blockNodes=function(){if(!this._range){return}this._blockNodes||(this._blockNodes=(function(T){return function(){return T.nodes().filter(function(U,V){return T.editor.util.isBlockNode(V)})}})(this)());return this._blockNodes};R.prototype.rootNodes=function(){if(!this._range){return}this._rootNodes||(this._rootNodes=(function(T){return function(){return T.nodes().filter(function(U,V){var W;W=B(V).parent();return W.is(T.editor.body)||W.is("blockquote")})}})(this)());return this._rootNodes};R.prototype.rangeAtEndOf=function(Z,X){var Y,W,V,U,aa,T;if(X==null){X=this.range()}if(!(X&&X.collapsed)){return}Z=B(Z)[0];V=X.endContainer;U=this.editor.util.getNodeLength(V);W=X.endOffset===U-1;aa=B(V).contents().last().is("br");Y=X.endOffset===U;if(!((W&&aa)||Y)){return false}if(Z===V){return true}else{if(!B.contains(Z,V)){return false}}T=true;B(V).parentsUntil(Z).addBack().each(function(ae,ag){var ad,af,ac,ab;ab=B(ag).parent().contents().filter(function(){return !(this!==ag&&this.nodeType===3&&!this.nodeValue)});ad=ab.last();ac=ad.get(0)===ag;af=ad.is("br")&&ad.prev().get(0)===ag;if(!(ac||af)){T=false;return false}});return T};R.prototype.rangeAtStartOf=function(W,U){var T,V;if(U==null){U=this.range()}if(!(U&&U.collapsed)){return}W=B(W)[0];V=U.startContainer;if(U.startOffset!==0){return false}if(W===V){return true}else{if(!B.contains(W,V)){return false}}T=true;B(V).parentsUntil(W).addBack().each(function(Y,Z){var X;X=B(Z).parent().contents().filter(function(){return !(this!==Z&&this.nodeType===3&&!this.nodeValue)});if(X.first().get(0)!==Z){return T=false}});return T};R.prototype.insertNode=function(U,T){if(T==null){T=this.range()}if(!T){return}U=B(U)[0];T.insertNode(U);return this.setRangeAfter(U,T)};R.prototype.setRangeAfter=function(U,T){if(T==null){T=this.range()}if(T==null){return}U=B(U)[0];T.setEndAfter(U);T.collapse(false);return this.range(T)};R.prototype.setRangeBefore=function(U,T){if(T==null){T=this.range()}if(T==null){return}U=B(U)[0];T.setEndBefore(U);T.collapse(false);return this.range(T)};R.prototype.setRangeAtStartOf=function(U,T){if(T==null){T=this.range()}U=B(U).get(0);T.setEnd(U,0);T.collapse(false);return this.range(T)};R.prototype.setRangeAtEndOf=function(V,Y){var aa,U,W,T,ab,Z,X;if(Y==null){Y=this.range()}U=B(V);V=U[0];if(!V){return}if(U.is("pre")){W=U.contents();if(W.length>0){T=W.last();Z=T.text();ab=this.editor.util.getNodeLength(T[0]);if(Z.charAt(Z.length-1)==="\n"){Y.setEnd(T[0],ab-1)}else{Y.setEnd(T[0],ab)}}else{Y.setEnd(V,0)}}else{X=this.editor.util.getNodeLength(V);if(V.nodeType!==3&&X>0){aa=B(V).contents().last();if(aa.is("br")){X-=1}else{if(aa[0].nodeType!==3&&this.editor.util.isEmptyNode(aa)){aa.append(this.editor.util.phBr);V=aa[0];X=0}}}Y.setEnd(V,X)}Y.collapse(false);return this.range(Y)};R.prototype.deleteRangeContents=function(T){var X,V,U,W;if(T==null){T=this.range()}W=T.cloneRange();U=T.cloneRange();W.collapse(true);U.collapse(false);V=this.rangeAtStartOf(this.editor.body,W);X=this.rangeAtEndOf(this.editor.body,U);if(!T.collapsed&&V&&X){this.editor.body.empty();T.setStart(this.editor.body[0],0);T.collapse(true);this.range(T)}else{T.deleteContents()}return T};R.prototype.breakBlockEl=function(V,T){var U;if(T==null){T=this.range()}U=B(V);if(!T.collapsed){return U}T.setStartBefore(U.get(0));if(T.collapsed){return U}return U.before(T.extractContents())};R.prototype.save=function(U){var T,W,V;if(U==null){U=this.range()}if(this._selectionSaved){return}W=U.cloneRange();W.collapse(false);V=B("<span/>").addClass("simditor-caret-start");T=B("<span/>").addClass("simditor-caret-end");W.insertNode(T[0]);U.insertNode(V[0]);this.clear();return this._selectionSaved=true};R.prototype.restore=function(){var V,Z,W,U,X,Y,T;if(!this._selectionSaved){return false}X=this.editor.body.find(".simditor-caret-start");V=this.editor.body.find(".simditor-caret-end");if(X.length&&V.length){Y=X.parent();T=Y.contents().index(X);Z=V.parent();W=Z.contents().index(V);if(Y[0]===Z[0]){W-=1}U=document.createRange();U.setStart(Y.get(0),T);U.setEnd(Z.get(0),W);X.remove();V.remove();this.range(U)}else{X.remove();V.remove()}this._selectionSaved=false;return U};return R})(i);x=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.pluginName="Formatter";R.prototype.opts={allowedTags:[],allowedAttributes:{},allowedStyles:{}};R.prototype._init=function(){this.editor=this._module;this._allowedTags=B.merge(["br","span","a","img","b","strong","i","strike","u","font","p","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","hr"],this.opts.allowedTags);this._allowedAttributes=B.extend({img:["src","alt","width","height","data-non-image"],a:["href","target"],font:["color"],code:["class"]},this.opts.allowedAttributes);this._allowedStyles=B.extend({span:["color","font-size"],b:["color","font-size"],i:["color","font-size"],strong:["color","font-size"],strike:["color","font-size"],u:["color","font-size"],p:["margin-left","text-align"],h1:["margin-left","text-align"],h2:["margin-left","text-align"],h3:["margin-left","text-align"],h4:["margin-left","text-align"]},this.opts.allowedStyles);return this.editor.body.on("click","a",function(T){return false})};R.prototype.decorate=function(T){if(T==null){T=this.editor.body}this.editor.trigger("decorate",[T]);return T};R.prototype.undecorate=function(T){if(T==null){T=this.editor.body.clone()}this.editor.trigger("undecorate",[T]);return T};R.prototype.autolink=function(ag){var ac,T,ad,Y,aa,ab,X,Z,af,W,V,ae,U;if(ag==null){ag=this.editor.body}X=[];ad=function(ah){return ah.contents().each(function(aj,ak){var ai,al;ai=B(ak);if(ai.is("a")||ai.closest("a, pre",ag).length){return}if(!ai.is("iframe")&&ai.contents().length){return ad(ai)}else{if((al=ai.text())&&/https?:\/\/|www\./ig.test(al)){return X.push(ai)}}})};ad(ag);af=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/ig;for(Y=0,ab=X.length;Y<ab;Y++){T=X[Y];ae=T.text();W=[];Z=null;aa=0;while((Z=af.exec(ae))!==null){V=ae.substring(aa,Z.index);W.push(document.createTextNode(V));aa=af.lastIndex;U=/^(http(s)?:\/\/|\/)/.test(Z[0])?Z[0]:"http://"+Z[0];ac=B('<a href="'+U+'" rel="nofollow"></a>').text(Z[0]);W.push(ac[0])}W.push(document.createTextNode(ae.substring(aa)));T.replaceWith(B(W))}return ag};R.prototype.format=function(ad){var T,ac,Y,X,aa,Z,V,W,U,ab;if(ad==null){ad=this.editor.body}if(ad.is(":empty")){ad.append("<p>"+this.editor.util.phBr+"</p>");return ad}U=ad.contents();for(Y=0,aa=U.length;Y<aa;Y++){V=U[Y];this.cleanNode(V,true)}ab=ad.contents();for(X=0,Z=ab.length;X<Z;X++){W=ab[X];T=B(W);if(T.is("br")){if(typeof ac!=="undefined"&&ac!==null){ac=null}T.remove()}else{if(this.editor.util.isBlockNode(W)){if(T.is("li")){if(ac&&ac.is("ul, ol")){ac.append(W)}else{ac=B("<ul/>").insertBefore(W);ac.append(W)}}else{ac=null}}else{if(!ac||ac.is("ul, ol")){ac=B("<p/>").insertBefore(W)}ac.append(W);if(this.editor.util.isEmptyNode(ac)){ac.append(this.editor.util.phBr)}}}}return ad};R.prototype.cleanNode=function(ac,ai){var W,ae,am,ak,U,aj,ab,ah,al,af,ad,ag,V,aa,T,Y,X,Z;am=B(ac);if(!(am.length>0)){return}if(am[0].nodeType===3){X=am.text().replace(/(\r\n|\n|\r)/gm,"");if(X){Z=document.createTextNode(X);am.replaceWith(Z)}else{am.remove()}return}ah=am.is("iframe")?null:am.contents();al=this.editor.util.isDecoratedNode(am);if(am.is(this._allowedTags.join(","))||al){if(am.is("a")&&(ae=am.find("img")).length>0){am.replaceWith(ae);am=ae;ah=null}if(am.is("td")&&(W=am.find(this.editor.util.blockNodes.join(","))).length>0){W.each((function(an){return function(ao,ap){return B(ap).contents().unwrap()}})(this));ah=am.contents()}if(am.is("img")&&am.hasClass("uploading")){am.remove()}if(!al){aj=this._allowedAttributes[am[0].tagName.toLowerCase()];T=B.makeArray(am[0].attributes);for(af=0,ag=T.length;af<ag;af++){ab=T[af];if(ab.name==="style"){continue}if(!((aj!=null)&&(Y=ab.name,p.call(aj,Y)>=0))){am.removeAttr(ab.name)}}this._cleanNodeStyles(am);if(am.is("span")){if(am[0].attributes.length===0){am.contents().first().unwrap()}if(am[0].style.length===2&&am[0].style.color==="rgb(51, 51, 51)"&&am[0].style.fontSize==="16px"){am.contents().unwrap()}}}}else{if(am[0].nodeType===1&&!am.is(":empty")){if(am.is("div, article, dl, header, footer, tr")){am.append("<br/>");ah.first().unwrap()}else{if(am.is("table")){ak=B("<p/>");am.find("tr").each(function(an,ao){return ak.append(B(ao).text()+"<br/>")});am.replaceWith(ak);ah=null}else{if(am.is("thead, tfoot")){am.remove();ah=null}else{if(am.is("th")){U=B("<td/>").append(am.contents());am.replaceWith(U)}else{ah.first().unwrap()}}}}}else{am.remove();ah=null}}if(ai&&(ah!=null)&&!am.is("pre")){for(ad=0,V=ah.length;ad<V;ad++){aa=ah[ad];this.cleanNode(aa,true)}}return null};R.prototype._cleanNodeStyles=function(U){var ab,X,Z,Y,V,aa,T,W,ac;W=U.attr("style");if(!W){return}U.removeAttr("style");ab=this._allowedStyles[U[0].tagName.toLowerCase()];if(!(ab&&ab.length>0)){return U}ac={};V=W.split(";");for(X=0,Z=V.length;X<Z;X++){T=V[X];T=B.trim(T);Y=T.split(":");if(Y.length!==2){continue}if(Y[0]==="font-size"&&Y[1].indexOf("px")>0){if(parseInt(Y[1],10)<12){continue}}if(aa=Y[0],p.call(ab,aa)>=0){ac[B.trim(Y[0])]=B.trim(Y[1])}}if(Object.keys(ac).length>0){U.css(ac)}return U};R.prototype.clearHtml=function(W,U){var V,X,T;if(U==null){U=true}V=B("<div/>").append(W);X=V.contents();T="";X.each((function(Y){return function(ab,ac){var Z,aa;if(ac.nodeType===3){return T+=ac.nodeValue}else{if(ac.nodeType===1){Z=B(ac);aa=Z.is("iframe")?null:Z.contents();if(aa&&aa.length>0){T+=Y.clearHtml(aa)}if(U&&ab<X.length-1&&Z.is("br, p, div, li,tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2,h3, h4, header")){return T+="\n"}}}}})(this));return T};R.prototype.beautify=function(T){var U;U=function(V){return !!(V.is("p")&&!V.text()&&V.children(":not(br)").length<1)};return T.each(function(W,X){var V,Y;V=B(X);Y=V.is(':not(img, br, col, td, hr, [class^="simditor-"]):empty');if(Y||U(V)){V.remove()}return V.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()})};return R})(i);t=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.pluginName="InputManager";S.prototype._modifierKeys=[16,17,18,91,93,224];S.prototype._arrowKeys=[37,38,39,40];S.prototype._init=function(){var U,T;this.editor=this._module;this.throttledValueChanged=this.editor.util.throttle((function(V){return function(W){return setTimeout(function(){return V.editor.trigger("valuechanged",W)},10)}})(this),300);this.throttledSelectionChanged=this.editor.util.throttle((function(V){return function(){return V.editor.trigger("selectionchanged")}})(this),50);B(document).on("selectionchange.simditor"+this.editor.id,(function(V){return function(X){var W;if(!(V.focused&&!V.editor.clipboard.pasting)){return}W=function(){if(V._selectionTimer){clearTimeout(V._selectionTimer);V._selectionTimer=null}if(V.editor.selection._selection.rangeCount>0){return V.throttledSelectionChanged()}else{return V._selectionTimer=setTimeout(function(){V._selectionTimer=null;if(V.focused){return W()}},10)}};return W()}})(this));this.editor.on("valuechanged",(function(V){return function(){var W;V.lastCaretPosition=null;W=V.editor.body.children().filter(function(X,Y){return V.editor.util.isBlockNode(Y)});if(V.focused&&W.length===0){V.editor.selection.save();V.editor.formatter.format();V.editor.selection.restore()}V.editor.body.find("hr, pre, .simditor-table").each(function(Y,Z){var X,aa;X=B(Z);if(X.parent().is("blockquote")||X.parent()[0]===V.editor.body[0]){aa=false;if(X.next().length===0){B("<p/>").append(V.editor.util.phBr).insertAfter(X);aa=true}if(X.prev().length===0){B("<p/>").append(V.editor.util.phBr).insertBefore(X);aa=true}if(aa){return V.throttledValueChanged()}}});V.editor.body.find("pre:empty").append(V.editor.util.phBr);if(!V.editor.util.support.onselectionchange&&V.focused){return V.throttledSelectionChanged()}}})(this));this.editor.body.on("keydown",B.proxy(this._onKeyDown,this)).on("keypress",B.proxy(this._onKeyPress,this)).on("keyup",B.proxy(this._onKeyUp,this)).on("mouseup",B.proxy(this._onMouseUp,this)).on("focus",B.proxy(this._onFocus,this)).on("blur",B.proxy(this._onBlur,this)).on("drop",B.proxy(this._onDrop,this)).on("input",B.proxy(this._onInput,this));if(this.editor.util.browser.firefox){this.editor.hotkeys.add("cmd+left",(function(V){return function(W){W.preventDefault();V.editor.selection._selection.modify("move","backward","lineboundary");return false}})(this));this.editor.hotkeys.add("cmd+right",(function(V){return function(W){W.preventDefault();V.editor.selection._selection.modify("move","forward","lineboundary");return false}})(this));U=this.editor.util.os.mac?"cmd+a":"ctrl+a";this.editor.hotkeys.add(U,(function(V){return function(aa){var X,Z,Y,W;X=V.editor.body.children();if(!(X.length>0)){return}Z=X.first().get(0);Y=X.last().get(0);W=document.createRange();W.setStart(Z,0);W.setEnd(Y,V.editor.util.getNodeLength(Y));V.editor.selection.range(W);return false}})(this))}T=this.editor.util.os.mac?"cmd+enter":"ctrl+enter";return this.editor.hotkeys.add(T,(function(V){return function(W){V.editor.sync();V.editor.el.closest("form").find("button:submit").click();return false}})(this))};S.prototype._onFocus=function(T){if(this.editor.clipboard.pasting){return}this.editor.el.addClass("focus").removeClass("error");this.focused=true;return setTimeout((function(U){return function(){var W,V;V=U.editor.selection._selection.getRangeAt(0);if(V.startContainer===U.editor.body[0]){if(U.lastCaretPosition){U.editor.undoManager.caretPosition(U.lastCaretPosition)}else{W=U.editor.body.children().first();V=document.createRange();U.editor.selection.setRangeAtStartOf(W,V)}}U.lastCaretPosition=null;U.editor.triggerHandler("focus");if(!U.editor.util.support.onselectionchange){return U.throttledSelectionChanged()}}})(this),0)};S.prototype._onBlur=function(U){var T;if(this.editor.clipboard.pasting){return}this.editor.el.removeClass("focus");this.editor.sync();this.focused=false;this.lastCaretPosition=(T=this.editor.undoManager.currentState())!=null?T.caret:void 0;return this.editor.triggerHandler("blur")};S.prototype._onMouseUp=function(T){if(!this.editor.util.support.onselectionchange){return this.throttledSelectionChanged()}};S.prototype._onKeyDown=function(V){var U,T;if(this.editor.triggerHandler(V)===false){return false}if(this.editor.hotkeys.respondTo(V)){return}if(this.editor.keystroke.respondTo(V)){this.throttledValueChanged();return false}if((U=V.which,p.call(this._modifierKeys,U)>=0)||(T=V.which,p.call(this._arrowKeys,T)>=0)){return}if(this.editor.util.metaKey(V)&&V.which===86){return}if(!this.editor.util.support.oninput){this.throttledValueChanged(["typing"])}return null};S.prototype._onKeyPress=function(T){if(this.editor.triggerHandler(T)===false){return false}};S.prototype._onKeyUp=function(V){var U,T;if(this.editor.triggerHandler(V)===false){return false}if(!this.editor.util.support.onselectionchange&&(T=V.which,p.call(this._arrowKeys,T)>=0)){this.throttledValueChanged();return}if((V.which===8||V.which===46)&&this.editor.util.isEmptyNode(this.editor.body)){this.editor.body.empty();U=B("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body);this.editor.selection.setRangeAtStartOf(U)}};S.prototype._onDrop=function(T){if(this.editor.triggerHandler(T)===false){return false}return this.throttledValueChanged()};S.prototype._onInput=function(T){return this.throttledValueChanged(["oninput"])};return S})(i);H=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.pluginName="Keystroke";S.prototype._init=function(){this.editor=this._module;this._keystrokeHandlers={};return this._initKeystrokeHandlers()};S.prototype.add=function(T,V,U){T=T.toLowerCase();T=this.editor.hotkeys.constructor.aliases[T]||T;if(!this._keystrokeHandlers[T]){this._keystrokeHandlers[T]={}}return this._keystrokeHandlers[T][V]=U};S.prototype.respondTo=function(X){var W,U,V,T;U=(V=this.editor.hotkeys.constructor.keyNameMap[X.which])!=null?V.toLowerCase():void 0;if(!U){return}if(U in this._keystrokeHandlers){T=typeof(W=this._keystrokeHandlers[U])["*"]==="function"?W["*"](X):void 0;if(!T){this.editor.selection.startNodes().each((function(Y){return function(aa,ac){var ab,Z;if(ac.nodeType!==Node.ELEMENT_NODE){return}ab=(Z=Y._keystrokeHandlers[U])!=null?Z[ac.tagName.toLowerCase()]:void 0;T=typeof ab==="function"?ab(X,B(ac)):void 0;if(T===true||T===false){return false}}})(this))}if(T){return true}}};S.prototype._initKeystrokeHandlers=function(){var T;if(this.editor.util.browser.safari){this.add("enter","*",(function(U){return function(X){var W,V;if(!X.shiftKey){return}W=U.editor.selection.blockNodes().last();if(W.is("pre")){return}V=B("<br/>");if(U.editor.selection.rangeAtEndOf(W)){U.editor.selection.insertNode(V);U.editor.selection.insertNode(B("<br/>"));U.editor.selection.setRangeBefore(V)}else{U.editor.selection.insertNode(V)}return true}})(this))}if(this.editor.util.browser.webkit||this.editor.util.browser.msie){T=(function(U){return function(X,V){var W;if(!U.editor.selection.rangeAtEndOf(V)){return}W=B("<p/>").append(U.editor.util.phBr).insertAfter(V);U.editor.selection.setRangeAtStartOf(W);return true}})(this);this.add("enter","h1",T);this.add("enter","h2",T);this.add("enter","h3",T);this.add("enter","h4",T);this.add("enter","h5",T);this.add("enter","h6",T)}this.add("backspace","*",(function(U){return function(Z){var Y,W,X,V;X=U.editor.selection.rootNodes().first();W=X.prev();if(W.is("hr")&&U.editor.selection.rangeAtStartOf(X)){U.editor.selection.save();W.remove();U.editor.selection.restore();return true}Y=U.editor.selection.blockNodes().last();if(Y.is(".simditor-resize-handle")&&X.is(".simditor-table")){Z.preventDefault();X.remove();U.editor.selection.setRangeAtEndOf(W)}if(W.is(".simditor-table")&&!Y.is("table")&&U.editor.util.isEmptyNode(Y)){Z.preventDefault();Y.remove();U.editor.selection.setRangeAtEndOf(W)}V=U.editor.util.browser.webkit;if(V&&U.editor.selection.rangeAtStartOf(Y)){U.editor.selection.save();U.editor.formatter.cleanNode(Y,true);U.editor.selection.restore();return null}}})(this));this.add("enter","div",(function(U){return function(Y,V){var X,W;if(V.is(".simditor-table")){X=U.editor.selection.blockNodes().last();if(X.is(".simditor-resize-handle")){Y.preventDefault();W=B("<p/>").append(U.editor.util.phBr).insertAfter(V);return U.editor.selection.setRangeAtStartOf(W)}}}})(this));this.add("enter","li",(function(U){return function(Y,V){var aa,X,W,Z;aa=V.clone();aa.find("ul, ol").remove();if(!(U.editor.util.isEmptyNode(aa)&&V.is(U.editor.selection.blockNodes().last()))){return}X=V.parent();if(V.next("li").length>0){if(!U.editor.util.isEmptyNode(V)){return}if(X.parent("li").length>0){W=B("<li/>").append(U.editor.util.phBr).insertAfter(X.parent("li"));Z=B("<"+X[0].tagName+"/>").append(V.nextAll("li"));W.append(Z)}else{W=B("<p/>").append(U.editor.util.phBr).insertAfter(X);Z=B("<"+X[0].tagName+"/>").append(V.nextAll("li"));W.after(Z)}}else{if(X.parent("li").length>0){W=B("<li/>").insertAfter(X.parent("li"));if(V.contents().length>0){W.append(V.contents())}else{W.append(U.editor.util.phBr)}}else{W=B("<p/>").append(U.editor.util.phBr).insertAfter(X);if(V.children("ul, ol").length>0){W.after(V.children("ul, ol"))}}}if(V.prev("li").length){V.remove()}else{if(V.prev("ul").length||V.prev("ol").length){V.remove()}else{X.remove()}}U.editor.selection.setRangeAtStartOf(W);return true}})(this));this.add("enter","pre",(function(U){return function(Z,X){var Y,V,W;Z.preventDefault();if(Z.shiftKey){Y=B("<p/>").append(U.editor.util.phBr).insertAfter(X);U.editor.selection.setRangeAtStartOf(Y);return true}W=U.editor.selection.range();V=null;W.deleteContents();if(!U.editor.util.browser.msie&&U.editor.selection.rangeAtEndOf(X)){V=document.createTextNode("\n\n")}else{V=document.createTextNode("\n")}W.insertNode(V);W.setEnd(V,1);W.collapse(false);U.editor.selection.range(W);return true}})(this));this.add("enter","blockquote",(function(U){return function(X,W){var Y,V;Y=U.editor.selection.blockNodes().last();if(!(Y.is("p")&&!Y.next().length&&U.editor.util.isEmptyNode(Y))){return}W.after(Y);V=document.createRange();U.editor.selection.setRangeAtStartOf(Y,V);return true}})(this));this.add("backspace","li",(function(U){return function(aa,W){var ac,Y,ae,V,ab,af,X,Z,ad;Y=W.children("ul, ol");ab=W.prev("li");if(!(Y.length>0&&ab.length>0)){return false}ad="";af=null;W.contents().each(function(ag,ah){if(ah.nodeType===1&&/UL|OL/.test(ah.nodeName)){return false}if(ah.nodeType===1&&/BR/.test(ah.nodeName)){return}if(ah.nodeType===3&&ah.nodeValue){ad+=ah.nodeValue}else{if(ah.nodeType===1){ad+=B(ah).text()}}return af=B(ah)});X=U.editor.util.browser.firefox&&!af.next("br").length;if(af&&ad.length===1&&X){ac=B(U.editor.util.phBr).insertAfter(af);af.remove();U.editor.selection.setRangeBefore(ac);return true}else{if(ad.length>0){return false}}Z=document.createRange();V=ab.children("ul, ol");if(V.length>0){ae=B("<li/>").append(U.editor.util.phBr).appendTo(V);V.append(Y.children("li"));W.remove();U.editor.selection.setRangeAtEndOf(ae,Z)}else{U.editor.selection.setRangeAtEndOf(ab,Z);ab.append(Y);W.remove();U.editor.selection.range(Z)}return true}})(this));this.add("backspace","pre",(function(U){return function(Z,X){var Y,V,W;if(!U.editor.selection.rangeAtStartOf(X)){return}V=X.html().replace("\n","<br/>")||U.editor.util.phBr;Y=B("<p/>").append(V).insertAfter(X);X.remove();W=document.createRange();U.editor.selection.setRangeAtStartOf(Y,W);return true}})(this));return this.add("backspace","blockquote",(function(U){return function(Y,W){var X,V;if(!U.editor.selection.rangeAtStartOf(W)){return}X=W.children().first().unwrap();V=document.createRange();U.editor.selection.setRangeAtStartOf(X,V);return true}})(this))};return S})(i);e=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.pluginName="UndoManager";S.prototype._index=-1;S.prototype._capacity=20;S.prototype._startPosition=null;S.prototype._endPosition=null;S.prototype._init=function(){var U,T;this.editor=this._module;this._stack=[];if(this.editor.util.os.mac){T="cmd+z";U="shift+cmd+z"}else{if(this.editor.util.os.win){T="ctrl+z";U="ctrl+y"}else{T="ctrl+z";U="shift+ctrl+z"}}this.editor.hotkeys.add(T,(function(V){return function(W){W.preventDefault();V.undo();return false}})(this));this.editor.hotkeys.add(U,(function(V){return function(W){W.preventDefault();V.redo();return false}})(this));this.throttledPushState=this.editor.util.throttle((function(V){return function(){return V._pushUndoState()}})(this),2000);this.editor.on("valuechanged",(function(V){return function(W,X){if(X==="undo"||X==="redo"){return}return V.throttledPushState()}})(this));this.editor.on("selectionchanged",(function(V){return function(W){V.resetCaretPosition();return V.update()}})(this));this.editor.on("focus",(function(V){return function(W){if(V._stack.length===0){return V._pushUndoState()}}})(this));return this.editor.on("blur",(function(V){return function(W){return V.resetCaretPosition()}})(this))};S.prototype.resetCaretPosition=function(){this._startPosition=null;return this._endPosition=null};S.prototype.startPosition=function(){if(this.editor.selection._range){this._startPosition||(this._startPosition=this._getPosition("start"))}return this._startPosition};S.prototype.endPosition=function(){if(this.editor.selection._range){this._endPosition||(this._endPosition=(function(T){return function(){var U;U=T.editor.selection.range();if(U.collapsed){return T._startPosition}return T._getPosition("end")}})(this)())}return this._endPosition};S.prototype._pushUndoState=function(){var T;if(this.editor.triggerHandler("pushundostate")===false){return}T=this.caretPosition();if(!T.start){return}this._index+=1;this._stack.length=this._index;this._stack.push({html:this.editor.body.html(),caret:this.caretPosition()});if(this._stack.length>this._capacity){this._stack.shift();return this._index-=1}};S.prototype.currentState=function(){if(this._stack.length&&this._index>-1){return this._stack[this._index]}else{return null}};S.prototype.undo=function(){var T;if(this._index<1||this._stack.length<2){return}this.editor.hidePopover();this._index-=1;T=this._stack[this._index];this.editor.body.get(0).innerHTML=T.html;this.caretPosition(T.caret);this.editor.body.find(".selected").removeClass("selected");this.editor.sync();return this.editor.trigger("valuechanged",["undo"])};S.prototype.redo=function(){var T;if(this._index<0||this._stack.length<this._index+2){return}this.editor.hidePopover();this._index+=1;T=this._stack[this._index];this.editor.body.get(0).innerHTML=T.html;this.caretPosition(T.caret);this.editor.body.find(".selected").removeClass("selected");this.editor.sync();return this.editor.trigger("valuechanged",["redo"])};S.prototype.update=function(){var T;T=this.currentState();if(!T){return}T.html=this.editor.body.html();return T.caret=this.caretPosition()};S.prototype._getNodeOffset=function(V,T){var W,U,X;if(B.isNumeric(T)){W=B(V)}else{W=B(V).parent()}X=0;U=false;W.contents().each(function(Y,Z){if(V===Z||(T===Y&&Y===0)){return false}if(Z.nodeType===Node.TEXT_NODE){if(!U&&Z.nodeValue.length>0){X+=1;U=true}}else{X+=1;U=false}if(T-1===Y){return false}return null});return X};S.prototype._getPosition=function(X){var aa,Y,W,Z,T,U,V;if(X==null){X="start"}V=this.editor.selection.range();Z=V[X+"Offset"];aa=this.editor.selection[X+"Nodes"]();Y=aa.first()[0];if(Y.nodeType===Node.TEXT_NODE){U=Y.previousSibling;while(U&&U.nodeType===Node.TEXT_NODE){Y=U;Z+=this.editor.util.getNodeLength(U);U=U.previousSibling}W=aa.get();W[0]=Y;aa=B(W)}else{Z=this._getNodeOffset(Y,Z)}T=[Z];aa.each((function(ab){return function(ac,ad){return T.unshift(ab._getNodeOffset(ad))}})(this));return T};S.prototype._getNodeByPosition=function(Z){var T,ab,Y,W,aa,V,X,U;V=this.editor.body[0];U=Z.slice(0,Z.length-1);for(Y=W=0,aa=U.length;W<aa;Y=++W){X=U[Y];ab=V.childNodes;if(X>ab.length-1){if(Y===Z.length-2&&B(V).is(":empty")){T=document.createTextNode("");V.appendChild(T);ab=V.childNodes}else{V=null;break}}V=ab[X]}return V};S.prototype.caretPosition=function(Y){var X,V,U,W,T;if(!Y){U=this.editor.selection.range();Y=this.editor.inputManager.focused&&(U!=null)?{start:this.startPosition(),end:this.endPosition(),collapsed:U.collapsed}:{};return Y}else{if(!Y.start){return}W=this._getNodeByPosition(Y.start);T=Y.start[Y.start.length-1];if(Y.collapsed){X=W;V=T}else{X=this._getNodeByPosition(Y.end);V=Y.start[Y.start.length-1]}if(!W||!X){if(typeof console!=="undefined"&&console!==null){if(typeof console.info==="function"){console.info("simditor: invalid caret state")}}return}U=document.createRange();U.setStart(W,T);U.setEnd(X,V);return this.editor.selection.range(U)}};return S})(i);a=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.pluginName="Util";S.prototype._init=function(){this.editor=this._module;if(this.browser.msie&&this.browser.version<11){return this.phBr=""}};S.prototype.phBr="<br/>";S.prototype.os=(function(){var T;T={};if(/Mac/.test(navigator.appVersion)){T.mac=true}else{if(/Linux/.test(navigator.appVersion)){T.linux=true}else{if(/Win/.test(navigator.appVersion)){T.win=true}else{if(/X11/.test(navigator.appVersion)){T.unix=true}}}}if(/Mobi/.test(navigator.appVersion)){T.mobile=true}return T})();S.prototype.browser=(function(){var Y,W,ac,V,X,ad,ab,aa,Z,U,T;T=navigator.userAgent;V=/(msie|trident)/i.test(T);Y=/chrome|crios/i.test(T);U=/safari/i.test(T)&&!Y;ac=/firefox/i.test(T);W=/edge/i.test(T);if(V){return{msie:true,version:((X=T.match(/(msie |rv:)(\d+(\.\d+)?)/i))!=null?X[2]:void 0)*1}}else{if(W){return{edge:true,webkit:true,version:((ad=T.match(/edge\/(\d+(\.\d+)?)/i))!=null?ad[1]:void 0)*1}}else{if(Y){return{webkit:true,chrome:true,version:((ab=T.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))!=null?ab[1]:void 0)*1}}else{if(U){return{webkit:true,safari:true,version:((aa=T.match(/version\/(\d+(\.\d+)?)/i))!=null?aa[1]:void 0)*1}}else{if(ac){return{mozilla:true,firefox:true,version:((Z=T.match(/firefox\/(\d+(\.\d+)?)/i))!=null?Z[1]:void 0)*1}}else{return{}}}}}}})();S.prototype.support=(function(){return{onselectionchange:(function(){var U,T;T=document.onselectionchange;if(T!==void 0){try{document.onselectionchange=0;return document.onselectionchange===null}catch(V){U=V}finally{document.onselectionchange=T}}return false})(),oninput:(function(){return !/(msie|trident)/i.test(navigator.userAgent)})()}})();S.prototype.reflow=function(T){if(T==null){T=document}return B(T)[0].offsetHeight};S.prototype.metaKey=function(U){var T;T=/Mac/.test(navigator.userAgent);if(T){return U.metaKey}else{return U.ctrlKey}};S.prototype.isEmptyNode=function(U){var T;T=B(U);return T.is(":empty")||(!T.text()&&!T.find(":not(br, span, div, b, a, strong, i, strike, font, u)").length)};S.prototype.isDecoratedNode=function(T){return B(T).is('[class^="simditor-"]')};S.prototype.blockNodes=["div","p","ul","ol","li","blockquote","hr","pre","h1","h2","h3","h4","h5","table"];S.prototype.isBlockNode=function(T){T=B(T)[0];if(!T||T.nodeType===3){return false}return new RegExp("^("+(this.blockNodes.join("|"))+")$").test(T.nodeName.toLowerCase())};S.prototype.getNodeLength=function(T){T=B(T)[0];switch(T.nodeType){case 7:case 10:return 0;case 3:case 8:return T.length;default:return T.childNodes.length}};S.prototype.dataURLtoBlob=function(V){var ab,ac,ad,ae,Y,T,aa,Z,af,X,W,U,ag;aa=window.Blob&&(function(){var ah;try{return Boolean(new Blob())}catch(ai){ah=ai;return false}})();T=aa&&window.Uint8Array&&(function(){var ah;try{return new Blob([new Uint8Array(100)]).size===100}catch(ai){ah=ai;return false}})();ab=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;ag=aa||ab;if(!(ag&&window.atob&&window.ArrayBuffer&&window.Uint8Array)){return false}if(V.split(",")[0].indexOf("base64")>=0){Y=atob(V.split(",")[1])}else{Y=decodeURIComponent(V.split(",")[1])}ac=new ArrayBuffer(Y.length);af=new Uint8Array(ac);for(Z=X=0,U=Y.length;0<=U?X<=U:X>=U;Z=0<=U?++X:--X){af[Z]=Y.charCodeAt(Z)}W=V.split(",")[0].split(":")[1].split(";")[0];if(aa){ae=T?af:ac;return new Blob([ae],{type:W})}ad=new ab();ad.append(ac);return ad.getBlob(W)};S.prototype.throttle=function(V,W){var Y,ab,aa,Z,X,T,U;Z=0;U=0;aa=Y=X=null;ab=function(){U=0;Z=+new Date();X=V.apply(aa,Y);aa=null;return Y=null};T=function(){var ac;aa=this;Y=arguments;ac=new Date()-Z;if(!U){if(ac>=W){ab()}else{U=setTimeout(ab,W-ac)}}return X};T.clear=function(){if(!U){return}clearTimeout(U);return ab()};return T};S.prototype.formatHTML=function(W){var aa,Z,V,T,X,ab,U,ac,Y;ab=/<(\/?)(.+?)(\/?)>/g;ac="";T=0;V=null;Z="  ";U=function(ad,ae){return new Array(ae+1).join(ad)};while((X=ab.exec(W))!==null){X.isBlockNode=B.inArray(X[2],this.blockNodes)>-1;X.isStartTag=X[1]!=="/"&&X[3]!=="/";X.isEndTag=X[1]==="/"||X[3]==="/";aa=V?V.index+V[0].length:0;if((Y=W.substring(aa,X.index)).length>0&&B.trim(Y)){ac+=Y}if(X.isBlockNode&&X.isEndTag&&!X.isStartTag){T-=1}if(X.isBlockNode&&X.isStartTag){if(!(V&&V.isBlockNode&&V.isEndTag)){ac+="\n"}ac+=U(Z,T)}ac+=X[0];if(X.isBlockNode&&X.isEndTag){ac+="\n"}if(X.isBlockNode&&X.isStartTag){T+=1}V=X}return B.trim(ac)};return S})(i);m=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.pluginName="Toolbar";R.prototype.opts={toolbar:true,toolbarFloat:true,toolbarHidden:false,toolbarFloatOffset:0,toolbarScrollContainer:window};R.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'};R.prototype._init=function(){var U,V,T,W;this.editor=this._module;if(!this.opts.toolbar){return}if(!B.isArray(this.opts.toolbar)){this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]}this._render();this.list.on("click",function(X){return false});this.wrapper.on("mousedown",(function(X){return function(Y){return X.list.find(".menu-on").removeClass(".menu-on")}})(this));B(document).on("mousedown.simditor"+this.editor.id,(function(X){return function(Y){return X.list.find(".menu-on").removeClass(".menu-on")}})(this));console.log(this.opts.toolbarHidden+"--"+!this.opts.toolbarHidden);console.log(this.opts.toolbarFloat);if(!this.opts.toolbarHidden&&this.opts.toolbarFloat){T=this.opts.toolbarScrollContainer===window?{top:0,left:0}:B(this.opts.toolbarScrollContainer).offset();this.wrapper.css("top",T.top+this.opts.toolbarFloatOffset);W=0;V=(function(X){return function(){X.wrapper.css("position","static");X.wrapper.width("auto");X.editor.util.reflow(X.wrapper);X.wrapper.width(X.wrapper.outerWidth());X.wrapper.css("left",X.editor.util.os.mobile?X.wrapper.position().left:X.wrapper.offset().left-T.left);X.wrapper.css("position","");W=X.wrapper.outerHeight();X.editor.placeholderEl.css("top",T.top);return true}})(this);U=null;B(window).on("resize.simditor-"+this.editor.id,function(X){return U=V()});B(this.opts.toolbarScrollContainer).on("scroll.simditor-"+this.editor.id,(function(X){return function(ab){var Y,aa,Z;if(!X.wrapper.is(":visible")){return}Z=X.opts.toolbarScrollContainer===window?X.editor.wrapper.get(0).getBoundingClientRect().top:X.editor.wrapper.offset().top-T.top;Y=Z+X.editor.wrapper.outerHeight()-80;aa=B(X.opts.toolbarScrollContainer).scrollTop()+X.opts.toolbarFloatOffset;if(Z>0||Y<0){X.editor.wrapper.removeClass("toolbar-floating").css("padding-top","");if(X.editor.util.os.mobile){return X.wrapper.css("top",X.opts.toolbarFloatOffset)}}else{U||(U=V());X.editor.wrapper.addClass("toolbar-floating").css("padding-top",W);if(X.editor.util.os.mobile){return X.wrapper.css("top",aa-Z+X.opts.toolbarFloatOffset)}}}})(this))}this.editor.on("destroy",(function(X){return function(){return X.buttons.length=0}})(this));return B(document).on("mousedown.simditor-"+this.editor.id,(function(X){return function(Y){return X.list.find("li.menu-on").removeClass("menu-on")}})(this))};R.prototype._render=function(){var U,T,V,W;this.buttons=[];this.wrapper=B(this._tpl.wrapper).prependTo(this.editor.wrapper);this.list=this.wrapper.find("ul");W=this.opts.toolbar;for(U=0,T=W.length;U<T;U++){V=W[U];if(V==="|"){B(this._tpl.separator).appendTo(this.list);continue}if(!this.constructor.buttons[V]){throw new Error("simditor: invalid toolbar button "+V);continue}this.buttons.push(new this.constructor.buttons[V]({editor:this.editor}))}if(this.opts.toolbarHidden){return this.wrapper.hide()}};R.prototype.findButton=function(T){var U;U=this.list.find(".toolbar-item-"+T).data("button");return U!=null?U:null};R.addButton=function(T){return this.buttons[T.prototype.name]=T};R.buttons={};return R})(i);N=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.pluginName="Indentation";S.prototype.opts={tabIndent:true};S.prototype._init=function(){this.editor=this._module;return this.editor.keystroke.add("tab","*",(function(T){return function(V){var U;U=T.editor.toolbar.findButton("code");if(!(T.opts.tabIndent||(U&&U.active))){return}return T.indent(V.shiftKey)}})(this))};S.prototype.indent=function(Y){var V,W,X,U,T;X=this.editor.selection.startNodes();W=this.editor.selection.endNodes();V=this.editor.selection.blockNodes();U=[];V=V.each(function(ad,ae){var aa,ac,ab,Z,af;aa=true;for(ac=ab=0,Z=U.length;ab<Z;ac=++ab){af=U[ac];if(B.contains(ae,af)){aa=false;break}else{if(B.contains(af,ae)){U.splice(ac,1,ae);aa=false;break}}}if(aa){return U.push(ae)}});V=B(U);T=false;V.each((function(Z){return function(aa,ac){var ab;ab=Y?Z.outdentBlock(ac):Z.indentBlock(ac);if(ab){return T=ab}}})(this));return T};S.prototype.indentBlock=function(V){var ad,X,ab,W,aa,ac,T,Z,Y,U;ad=B(V);if(!ad.length){return}if(ad.is("pre")){ac=this.editor.selection.containerNode();if(!(ac.is(ad)||ac.closest("pre").is(ad))){return}this.indentText(this.editor.selection.range())}else{if(ad.is("li")){aa=ad.prev("li");if(aa.length<1){return}this.editor.selection.save();U=ad.parent()[0].tagName;X=aa.children("ul, ol");if(X.length>0){X.append(ad)}else{B("<"+U+"/>").append(ad).appendTo(aa)}this.editor.selection.restore()}else{if(ad.is("p, h1, h2, h3, h4")){Y=parseInt(ad.css("margin-left"))||0;Y=(Math.round(Y/this.opts.indentWidth)+1)*this.opts.indentWidth;ad.css("margin-left",Y)}else{if(ad.is("table")||ad.is(".simditor-table")){T=this.editor.selection.containerNode().closest("td, th");ab=T.next("td, th");if(!(ab.length>0)){Z=T.parent("tr");W=Z.next("tr");if(W.length<1&&Z.parent().is("thead")){W=Z.parent("thead").next("tbody").find("tr:first")}ab=W.find("td:first, th:first")}if(!(T.length>0&&ab.length>0)){return}this.editor.selection.setRangeAtEndOf(ab)}else{return false}}}}return true};S.prototype.indentText=function(T){var V,U;V=T.toString().replace(/^(?=.+)/mg,"\u00A0\u00A0");U=document.createTextNode(V||"\u00A0\u00A0");T.deleteContents();T.insertNode(U);if(V){T.selectNode(U);return this.editor.selection.range(T)}else{return this.editor.selection.setRangeAfter(U)}};S.prototype.outdentBlock=function(V){var ad,X,ab,ac,aa,T,U,Z,W,Y;ad=B(V);if(!(ad&&ad.length>0)){return}if(ad.is("pre")){ac=this.editor.selection.containerNode();if(!(ac.is(ad)||ac.closest("pre").is(ad))){return}this.outdentText(Y)}else{if(ad.is("li")){X=ad.parent();ab=X.parent("li");this.editor.selection.save();if(ab.length<1){Y=document.createRange();Y.setStartBefore(X[0]);Y.setEndBefore(ad[0]);X.before(Y.extractContents());B("<p/>").insertBefore(X).after(ad.children("ul, ol")).append(ad.contents());ad.remove()}else{if(ad.next("li").length>0){B("<"+X[0].tagName+"/>").append(ad.nextAll("li")).appendTo(ad)}ad.insertAfter(ab);if(X.children("li").length<1){X.remove()}}this.editor.selection.restore()}else{if(ad.is("p, h1, h2, h3, h4")){W=parseInt(ad.css("margin-left"))||0;W=Math.max(Math.round(W/this.opts.indentWidth)-1,0)*this.opts.indentWidth;ad.css("margin-left",W===0?"":W)}else{if(ad.is("table")||ad.is(".simditor-table")){U=this.editor.selection.containerNode().closest("td, th");aa=U.prev("td, th");if(!(aa.length>0)){Z=U.parent("tr");T=Z.prev("tr");if(T.length<1&&Z.parent().is("tbody")){T=Z.parent("tbody").prev("thead").find("tr:first")}aa=T.find("td:last, th:last")}if(!(U.length>0&&aa.length>0)){return}this.editor.selection.setRangeAtEndOf(aa)}else{return false}}}}return true};S.prototype.outdentText=function(T){};return S})(i);o=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.pluginName="Clipboard";S.prototype.opts={pasteImage:false,cleanPaste:false};S.prototype._init=function(){this.editor=this._module;if(this.opts.pasteImage&&typeof this.opts.pasteImage!=="string"){this.opts.pasteImage="inline"}return this.editor.body.on("paste",(function(T){return function(V){var W,U;if(T.pasting||T._pasteBin){return}if(T.editor.triggerHandler(V)===false){return false}U=T.editor.selection.deleteRangeContents();if(T.editor.body.html()){if(!U.collapsed){U.collapse(true)}}else{T.editor.formatter.format();T.editor.selection.setRangeAtStartOf(T.editor.body.find("p:first"));U=T.editor.selection._range}if(T._processPasteByClipboardApi(V)){return false}W=B("<span>");U.insertNode(W[0]);T._createPasteBin(W);W.remove();U.collapse(true);T.editor.selection.range(U);T.editor.inputManager.throttledValueChanged.clear();T.editor.inputManager.throttledSelectionChanged.clear();T.editor.undoManager.throttledPushState.clear();T.editor.selection.reset();T.editor.undoManager.resetCaretPosition();T.pasting=true;return T._getPasteContent(function(X){T._processPasteContent(X);T._pasteInBlockEl=null;T._pastePlainText=null;return T.pasting=false})}})(this))};S.prototype._processPasteByClipboardApi=function(X){var W,T,V,U;if(X.originalEvent.clipboardData&&X.originalEvent.clipboardData.items&&X.originalEvent.clipboardData.items.length>0){T=X.originalEvent.clipboardData.items[0];if(/^image\//.test(T.type)){W=T.getAsFile();if(!((W!=null)&&this.opts.pasteImage)){return}if(!W.name){W.name="Clipboard Image.png"}if(this.editor.triggerHandler("pasting",[W])===false){return}U={};U[this.opts.pasteImage]=true;if((V=this.editor.uploader)!=null){V.upload(W,U)}return true}}};S.prototype._createPasteBin=function(T){var U,V;U=T.offset();V=this.editor.el.offset();return this._pasteBin=B('<div contenteditable="true" />').addClass("simditor-paste-bin").attr("tabIndex","-1").css({top:U.top-V.top,left:U.left-V.left}).appendTo(this.editor.el)};S.prototype._getPasteContent=function(U){var T;T={html:this.editor.body.html(),caret:this.editor.undoManager.caretPosition()};this._pasteBin.focus();return setTimeout((function(V){return function(){var W;V.editor.hidePopover();V.editor.body.get(0).innerHTML=F?F.sanitize(T.html):T.html;V.editor.undoManager.caretPosition(T.caret);V.editor.body.focus();V.editor.selection.reset();V.editor.selection.range();V._pasteInBlockEl=V.editor.selection.blockNodes().last();V._pastePlainText=V.opts.cleanPaste||V._pasteInBlockEl.is("pre, table");if(V._pastePlainText){W=V.editor.formatter.clearHtml(V._pasteBin.html(),true)}else{W=B("<div/>").append(V._pasteBin.contents());W.find("style").remove();W.find("table colgroup").remove();V._cleanPasteFontSize(W);V.editor.formatter.format(W);V.editor.formatter.decorate(W);V.editor.formatter.beautify(W.children());W=W.contents()}V._pasteBin.remove();V._pasteBin=null;return U(W)}})(this),0)};S.prototype._processPasteContent=function(ag){var ae,ac,T,W,ap,au,ar,ao,an,V,aq,ab,aa,Z,Y,ad,U,am,al,aj,ai,X,ah,af,at,ak;if(this.editor.triggerHandler("pasting",[ag])===false){return}ae=this._pasteInBlockEl;if(!ag){return}if(this._pastePlainText){if(ae.is("table")){U=ag.split("\n");V=U.pop();for(ao=0,aq=U.length;ao<aq;ao++){ad=U[ao];this.editor.selection.insertNode(document.createTextNode(ad));this.editor.selection.insertNode(B("<br/>"))}this.editor.selection.insertNode(document.createTextNode(V))}else{ag=B("<div/>").text(ag);X=ag.contents();for(an=0,ab=X.length;an<ab;an++){al=X[an];this.editor.selection.insertNode(B(al)[0])}}}else{if(ae.is(this.editor.body)){for(am=0,aa=ag.length;am<aa;am++){al=ag[am];this.editor.selection.insertNode(al)}}else{if(ag.length<1){return}else{if(ag.length===1){if(ag.is("p")){W=ag.contents();if(ae.is("h1, h2, h3, h4, h5")){if(W.length){W.css("font-size","")}}if(W.length===1&&W.is("img")){ac=W;if(/^data:image/.test(ac.attr("src"))){if(!this.opts.pasteImage){return}T=this.editor.util.dataURLtoBlob(ac.attr("src"));T.name="Clipboard Image.png";at={};at[this.opts.pasteImage]=true;if((ah=this.editor.uploader)!=null){ah.upload(T,at)}return}else{if(new RegExp("^blob:"+location.origin+"/").test(ac.attr("src"))){if(!this.opts.pasteImage){return}at={};at[this.opts.pasteImage]=true;ap=this.editor.util.dataURLtoBlob;ak=this.editor.uploader;au=new Image;au.onload=function(){var av;av=document.createElement("canvas");av.width=au.naturalWidth;av.height=au.naturalHeight;av.getContext("2d").drawImage(au,0,0);T=ap(av.toDataURL("image/png"));T.name="Clipboard Image.png";if(ak!==null){ak.upload(T,at)}};au.src=ac.attr("src");return}else{if(ac.is('img[src^="webkit-fake-url://"]')){return}}}}for(aj=0,Z=W.length;aj<Z;aj++){al=W[aj];this.editor.selection.insertNode(al)}}else{if(ae.is("p")&&this.editor.util.isEmptyNode(ae)){ae.replaceWith(ag);this.editor.selection.setRangeAtEndOf(ag)}else{if(ag.is("ul, ol")){if(ag.find("li").length===1){ag=B("<div/>").text(ag.text());af=ag.contents();for(ai=0,Y=af.length;ai<Y;ai++){al=af[ai];this.editor.selection.insertNode(B(al)[0])}}else{if(ae.is("li")){ae.parent().after(ag);this.editor.selection.setRangeAtEndOf(ag)}else{ae.after(ag);this.editor.selection.setRangeAtEndOf(ag)}}}else{ae.after(ag);this.editor.selection.setRangeAtEndOf(ag)}}}}else{if(ae.is("li")){ae=ae.parent()}if(this.editor.selection.rangeAtStartOf(ae)){ar="before"}else{if(this.editor.selection.rangeAtEndOf(ae)){ar="after"}else{this.editor.selection.breakBlockEl(ae);ar="before"}}ae[ar](ag);this.editor.selection.setRangeAtEndOf(ag.last())}}}}return this.editor.inputManager.throttledValueChanged()};S.prototype._cleanPasteFontSize=function(V){var T,U;T=B(V);if(!(T.length>0)){return}U=["1.5em","1.25em","0.75em","0.5em"];return T.find('[style*="font-size"]').map(function(X,Y){var W;W=B(Y);if(B.inArray(W.css("font-size"),U)<0){return W.css("font-size","")}})};return S})(i);M=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.connect(a);S.connect(t);S.connect(E);S.connect(e);S.connect(H);S.connect(x);S.connect(m);S.connect(N);S.connect(o);S.count=0;S.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:false,indentWidth:40};S.prototype._init=function(){var V,T,U;this.textarea=B(this.opts.textarea);this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder");if(!this.textarea.length){throw new Error("simditor: param textarea is required.");return}T=this.textarea.data("simditor");if(T!=null){T.destroy()}this.id=++S.count;this._render();if(j){this.hotkeys=j({el:this.body})}else{throw new Error("simditor: simple-hotkeys is required.");return}if(this.opts.upload&&P){U=typeof this.opts.upload==="object"?this.opts.upload:{};this.uploader=P(U)}this.on("initialized",(function(X){return function(){if(X.opts.placeholder){X.on("valuechanged",function(){return X._placeholder()})}X.setValue(X.textarea.val().trim()||"");if(X.textarea.attr("autofocus")){return X.focus()}}})(this));if(this.util.browser.mozilla){this.util.reflow();try{document.execCommand("enableObjectResizing",false,false);return document.execCommand("enableInlineTableEditing",false,false)}catch(W){V=W}}};S.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>';S.prototype._render=function(){var U,V,T,W;this.el=B(this._tpl).insertBefore(this.textarea);this.wrapper=this.el.find(".simditor-wrapper");this.body=this.wrapper.find(".simditor-body");this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder);this.el.data("simditor",this);this.wrapper.append(this.textarea);this.textarea.data("simditor",this).blur();this.body.attr("tabindex",this.textarea.attr("tabindex"));if(this.util.os.mac){this.el.addClass("simditor-mac")}else{if(this.util.os.linux){this.el.addClass("simditor-linux")}}if(this.util.os.mobile){this.el.addClass("simditor-mobile")}if(this.opts.params){V=this.opts.params;T=[];for(U in V){W=V[U];T.push(B("<input/>",{type:"hidden",name:U,value:W}).insertAfter(this.textarea))}return T}};S.prototype._placeholder=function(){var T;T=this.body.children();if(T.length===0||(T.length===1&&this.util.isEmptyNode(T)&&parseInt(T.css("margin-left")||0)<this.opts.indentWidth)){return this.placeholderEl.show()}else{return this.placeholderEl.hide()}};S.prototype.setValue=function(T){this.hidePopover();this.textarea.val(T);this.body.get(0).innerHTML=F?F.sanitize(T):T;this.formatter.format();this.formatter.decorate();this.util.reflow(this.body);this.inputManager.lastCaretPosition=null;return this.trigger("valuechanged")};S.prototype.getValue=function(){return this.sync()};S.prototype.sync=function(){var W,X,V,T,U,Y;X=this.body.clone();this.formatter.undecorate(X);this.formatter.format(X);this.formatter.autolink(X);W=X.children();U=W.last("p");T=W.first("p");while(U.is("p")&&this.util.isEmptyNode(U)){V=U;U=U.prev("p");V.remove()}while(T.is("p")&&this.util.isEmptyNode(T)){V=T;T=U.next("p");V.remove()}X.find("img.uploading").remove();Y=B.trim(X.html());this.textarea.val(Y);return Y};S.prototype.focus=function(){var U,T;if(!(this.body.is(":visible")&&this.body.is("[contenteditable]"))){this.el.find("textarea:visible").focus();return}if(this.inputManager.lastCaretPosition){this.undoManager.caretPosition(this.inputManager.lastCaretPosition);return this.inputManager.lastCaretPosition=null}else{U=this.body.children().last();if(!U.is("p")){U=B("<p/>").append(this.util.phBr).appendTo(this.body)}T=document.createRange();return this.selection.setRangeAtEndOf(U,T)}};S.prototype.blur=function(){if(this.body.is(":visible")&&this.body.is("[contenteditable]")){return this.body.blur()}else{return this.body.find("textarea:visible").blur()}};S.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(T,U){U=B(U).data("popover");if(U.active){return U.hide()}})};S.prototype.destroy=function(){this.triggerHandler("destroy");this.textarea.closest("form").off(".simditor .simditor-"+this.id);this.selection.clear();this.inputManager.focused=false;this.textarea.insertBefore(this.el).hide().val("").removeData("simditor");this.el.remove();B(document).off(".simditor-"+this.id);B(window).off(".simditor-"+this.id);return this.off()};return S})(i);M.i18n={"zh-CN":{blockquote:"引用",bold:"加粗文字",code:"插入代码",color:"文字颜色",coloredText:"彩色文字",hr:"分隔线",image:"插入图片",externalImage:"外链图片",uploadImage:"上传图片",uploadFailed:"上传失败了",uploadError:"上传出错了",imageUrl:"图片地址",imageSize:"图片尺寸",imageAlt:"图片描述",restoreImageSize:"还原图片尺寸",uploading:"正在上传",indent:"向右缩进",outdent:"向左缩进",italic:"斜体文字",link:"插入链接",linkText:"链接文字",linkUrl:"链接地址",linkTarget:"打开方式",openLinkInCurrentWindow:"在当前窗口中打开",openLinkInNewWindow:"在新窗口中打开",removeLink:"移除链接",ol:"有序列表",ul:"无序列表",strikethrough:"删除线文字",table:"表格",deleteRow:"删除行",insertRowAbove:"在上面插入行",insertRowBelow:"在下面插入行",deleteColumn:"删除列",insertColumnLeft:"在左边插入列",insertColumnRight:"在右边插入列",deleteTable:"删除表格",title:"标题",normalText:"普通文本",underline:"下划线文字",alignment:"水平对齐",alignCenter:"居中",alignLeft:"居左",alignRight:"居右",selectLanguage:"选择程序语言",fontScale:"字体大小",fontScaleXLarge:"超大字体",fontScaleLarge:"大号字体",fontScaleNormal:"正常大小",fontScaleSmall:"小号字体",fontScaleXSmall:"超小字体"},"en-US":{blockquote:"Block Quote",bold:"Bold",code:"Code",color:"Text Color",coloredText:"Colored Text",hr:"Horizontal Line",image:"Insert Image",externalImage:"External Image",uploadImage:"Upload Image",uploadFailed:"Upload failed",uploadError:"Error occurs during upload",imageUrl:"Url",imageSize:"Size",imageAlt:"Alt",restoreImageSize:"Restore Origin Size",uploading:"Uploading",indent:"Indent",outdent:"Outdent",italic:"Italic",link:"Insert Link",linkText:"Text",linkUrl:"Url",linkTarget:"Target",openLinkInCurrentWindow:"Open link in current window",openLinkInNewWindow:"Open link in new window",removeLink:"Remove Link",ol:"Ordered List",ul:"Unordered List",strikethrough:"Strikethrough",table:"Table",deleteRow:"Delete Row",insertRowAbove:"Insert Row Above",insertRowBelow:"Insert Row Below",deleteColumn:"Delete Column",insertColumnLeft:"Insert Column Left",insertColumnRight:"Insert Column Right",deleteTable:"Delete Table",title:"Title",normalText:"Text",underline:"Underline",alignment:"Alignment",alignCenter:"Align Center",alignLeft:"Align Left",alignRight:"Align Right",selectLanguage:"Select Language",fontScale:"Font Size",fontScaleXLarge:"X Large Size",fontScaleLarge:"Large Size",fontScaleNormal:"Normal Size",fontScaleSmall:"Small Size",fontScaleXSmall:"X Small Size"}};L=(function(S){l(R,S);R.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'};R.prototype.name="";R.prototype.icon="";R.prototype.title="";R.prototype.text="";R.prototype.htmlTag="";R.prototype.disableTag="";R.prototype.menu=false;R.prototype.active=false;R.prototype.disabled=false;R.prototype.needFocus=true;R.prototype.shortcut=null;function R(T){this.editor=T.editor;this.title=this._t(this.name);R.__super__.constructor.call(this,T)}R.prototype._init=function(){var V,U,W,T;this.render();this.el.on("mousedown",(function(X){return function(Y){var ab,aa,Z;Y.preventDefault();aa=X.needFocus&&!X.editor.inputManager.focused;if(X.el.hasClass("disabled")){return false}if(aa){X.editor.focus()}if(X.menu){X.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on");if(X.wrapper.is(".menu-on")){ab=X.menuWrapper.offset().left+X.menuWrapper.outerWidth()+5-X.editor.wrapper.offset().left-X.editor.wrapper.outerWidth();if(ab>0){X.menuWrapper.css({left:"auto",right:0})}X.trigger("menuexpand")}return false}Z=X.el.data("param");X.command(Z);return false}})(this));this.wrapper.on("click","a.menu-item",(function(X){return function(Z){var Y,ab,aa;Z.preventDefault();Y=B(Z.currentTarget);X.wrapper.removeClass("menu-on");ab=X.needFocus&&!X.editor.inputManager.focused;if(Y.hasClass("disabled")||ab){return false}X.editor.toolbar.wrapper.removeClass("menu-on");aa=Y.data("param");X.command(aa);return false}})(this));this.wrapper.on("mousedown","a.menu-item",function(X){return false});this.editor.on("blur",(function(X){return function(){var Y;Y=X.editor.body.is(":visible")&&X.editor.body.is("[contenteditable]");if(!(Y&&!X.editor.clipboard.pasting)){return}X.setActive(false);return X.setDisabled(false)}})(this));if(this.shortcut!=null){this.editor.hotkeys.add(this.shortcut,(function(X){return function(Y){X.el.mousedown();return false}})(this))}W=this.htmlTag.split(",");for(V=0,U=W.length;V<U;V++){T=W[V];T=B.trim(T);if(T&&B.inArray(T,this.editor.formatter._allowedTags)<0){this.editor.formatter._allowedTags.push(T)}}return this.editor.on("selectionchanged",(function(X){return function(Y){if(X.editor.inputManager.focused){return X._status()}}})(this))};R.prototype.iconClassOf=function(T){if(T){return"simditor-icon simditor-icon-"+T}else{return""}};R.prototype.setIcon=function(T){return this.el.find("span").removeClass().addClass(this.iconClassOf(T)).text(this.text)};R.prototype.render=function(){this.wrapper=B(this._tpl.item).appendTo(this.editor.toolbar.list);this.el=this.wrapper.find("a.toolbar-item");this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this);this.setIcon(this.icon);if(!this.menu){return}this.menuWrapper=B(this._tpl.menuWrapper).appendTo(this.wrapper);this.menuWrapper.addClass("toolbar-menu-"+this.name);return this.renderMenu()};R.prototype.renderMenu=function(){var X,W,V,T,Z,aa,U,Y;if(!B.isArray(this.menu)){return}this.menuEl=B("<ul/>").appendTo(this.menuWrapper);aa=this.menu;Y=[];for(V=0,T=aa.length;V<T;V++){Z=aa[V];if(Z==="|"){B(this._tpl.separator).appendTo(this.menuEl);continue}W=B(this._tpl.menuItem).appendTo(this.menuEl);X=W.find("a.menu-item").attr({title:(U=Z.title)!=null?U:Z.text,"data-param":Z.param}).addClass("menu-item-"+Z.name);if(Z.icon){Y.push(X.find("span").addClass(this.iconClassOf(Z.icon)))}else{Y.push(X.find("span").text(Z.text))}}return Y};R.prototype.setActive=function(T){if(T===this.active){return}this.active=T;return this.el.toggleClass("active",this.active)};R.prototype.setDisabled=function(T){if(T===this.disabled){return}this.disabled=T;return this.el.toggleClass("disabled",this.disabled)};R.prototype._disableStatus=function(){var T,U,V;V=this.editor.selection.startNodes();U=this.editor.selection.endNodes();T=V.filter(this.disableTag).length>0||U.filter(this.disableTag).length>0;this.setDisabled(T);if(this.disabled){this.setActive(false)}return this.disabled};R.prototype._activeStatus=function(){var X,T,V,U,W;W=this.editor.selection.startNodes();V=this.editor.selection.endNodes();U=W.filter(this.htmlTag);T=V.filter(this.htmlTag);X=U.length>0&&T.length>0&&U.is(T);this.node=X?U:null;this.setActive(X);return this.active};R.prototype._status=function(){this._disableStatus();if(this.disabled){return}return this._activeStatus()};R.prototype.command=function(T){};R.prototype._t=function(){var U,V,T;U=1<=arguments.length?n.call(arguments,0):[];T=R.__super__._t.apply(this,U);if(!T){T=(V=this.editor)._t.apply(V,U)}return T};return R})(i);M.Button=L;z=(function(S){l(R,S);R.prototype.offset={top:4,left:0};R.prototype.target=null;R.prototype.active=false;function R(T){this.button=T.button;this.editor=T.button.editor;R.__super__.constructor.call(this,T)}R.prototype._init=function(){this.el=B('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this);this.render();this.el.on("mouseenter",(function(T){return function(U){return T.el.addClass("hover")}})(this));return this.el.on("mouseleave",(function(T){return function(U){return T.el.removeClass("hover")}})(this))};R.prototype.render=function(){};R.prototype._initLabelWidth=function(){var T;T=this.el.find(".settings-field");if(!(T.length>0)){return}this._labelWidth=0;T.each((function(U){return function(W,Y){var X,V;X=B(Y);V=X.find("label");if(!(V.length>0)){return}return U._labelWidth=Math.max(U._labelWidth,V.width())}})(this));return T.find("label").width(this._labelWidth)};R.prototype.show=function(U,T){if(T==null){T="bottom"}if(U==null){return}this.el.siblings(".simditor-popover").each(function(V,W){W=B(W).data("popover");if(W&&W.active){return W.hide()}});if(this.active&&this.target){this.target.removeClass("selected")}this.target=U.addClass("selected");if(this.active){this.refresh(T);return this.trigger("popovershow")}else{this.active=true;this.el.css({left:-9999}).show();if(!this._labelWidth){this._initLabelWidth()}this.editor.util.reflow();this.refresh(T);return this.trigger("popovershow")}};R.prototype.hide=function(){if(!this.active){return}if(this.target){this.target.removeClass("selected")}this.target=null;this.active=false;this.el.hide();return this.trigger("popoverhide")};R.prototype.refresh=function(U){var Z,X,V,T,Y,W;if(U==null){U="bottom"}if(!this.active){return}Z=this.editor.el.offset();Y=this.target.offset();T=this.target.outerHeight();if(U==="bottom"){W=Y.top-Z.top+T}else{if(U==="top"){W=Y.top-Z.top-this.el.height()}}V=this.editor.wrapper.width()-this.el.outerWidth()-10;X=Math.min(Y.left-Z.left,V);return this.el.css({top:W+this.offset.top,left:X+this.offset.left})};R.prototype.destroy=function(){this.target=null;this.active=false;this.editor.off(".linkpopover");return this.el.remove()};R.prototype._t=function(){var U,V,T;U=1<=arguments.length?n.call(arguments,0):[];T=R.__super__._t.apply(this,U);if(!T){T=(V=this.button)._t.apply(V,U)}return T};return R})(i);M.Popover=z;w=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.name="title";R.prototype.htmlTag="h1, h2, h3, h4, h5";R.prototype.disableTag="pre, table";R.prototype._init=function(){this.menu=[{name:"normal",text:this._t("normalText"),param:"p"},"|",{name:"h1",text:this._t("title")+" 1",param:"h1"},{name:"h2",text:this._t("title")+" 2",param:"h2"},{name:"h3",text:this._t("title")+" 3",param:"h3"},{name:"h4",text:this._t("title")+" 4",param:"h4"},{name:"h5",text:this._t("title")+" 5",param:"h5"}];return R.__super__._init.call(this)};R.prototype.setActive=function(T,U){R.__super__.setActive.call(this,T);if(T){U||(U=this.node[0].tagName.toLowerCase())}this.el.removeClass("active-p active-h1 active-h2 active-h3 active-h4 active-h5");if(T){return this.el.addClass("active active-"+U)}};R.prototype.command=function(U){var T;T=this.editor.selection.rootNodes();this.editor.selection.save();T.each((function(V){return function(X,Y){var W;W=B(Y);if(W.is("blockquote")||W.is(U)||W.is(V.disableTag)||V.editor.util.isDecoratedNode(W)){return}return B("<"+U+"/>").append(W.contents()).replaceAll(W)}})(this));this.editor.selection.restore();return this.editor.trigger("valuechanged")};return R})(L);M.Toolbar.addButton(w);b=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.name="fontScale";R.prototype.icon="font";R.prototype.htmlTag="span";R.prototype.disableTag="pre, h1, h2, h3, h4, h5";R.prototype.sizeMap={"x-large":"1.5em",large:"1.25em",small:".75em","x-small":".5em"};R.prototype._init=function(){this.menu=[{name:"150%",text:this._t("fontScaleXLarge"),param:"5"},{name:"125%",text:this._t("fontScaleLarge"),param:"4"},{name:"100%",text:this._t("fontScaleNormal"),param:"3"},{name:"75%",text:this._t("fontScaleSmall"),param:"2"},{name:"50%",text:this._t("fontScaleXSmall"),param:"1"}];return R.__super__._init.call(this)};R.prototype._activeStatus=function(){var Y,T,W,U,V,X;U=this.editor.selection.range();X=this.editor.selection.startNodes();W=this.editor.selection.endNodes();V=X.filter('span[style*="font-size"]');T=W.filter('span[style*="font-size"]');Y=X.length>0&&W.length>0&&V.is(T);this.setActive(Y);return this.active};R.prototype.command=function(W){var U,T,V;V=this.editor.selection.range();if(V.collapsed){return}this.editor.selection.range(V);document.execCommand("styleWithCSS",false,true);document.execCommand("fontSize",false,W);document.execCommand("styleWithCSS",false,false);this.editor.selection.reset();this.editor.selection.range();T=this.editor.selection.containerNode();if(T[0].nodeType===Node.TEXT_NODE){U=T.closest('span[style*="font-size"]')}else{U=T.find('span[style*="font-size"]')}U.each((function(X){return function(aa,ab){var Y,Z;Y=B(ab);Z=ab.style.fontSize;if(/large|x-large|small|x-small/.test(Z)){return Y.css("fontSize",X.sizeMap[Z])}else{if(Z==="medium"){if(Y[0].style.length>1){return Y.css("fontSize","")}else{return Y.replaceWith(Y.contents())}}}}})(this));return this.editor.trigger("valuechanged")};return R})(L);M.Toolbar.addButton(b);y=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.name="bold";R.prototype.icon="bold";R.prototype.htmlTag="b, strong";R.prototype.disableTag="pre";R.prototype.shortcut="cmd+b";R.prototype._init=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + b )"}else{this.title=this.title+" ( Ctrl + b )";this.shortcut="ctrl+b"}return R.__super__._init.call(this)};R.prototype._activeStatus=function(){var T;T=document.queryCommandState("bold")===true;this.setActive(T);return this.active};R.prototype.command=function(){document.execCommand("bold");if(!this.editor.util.support.oninput){this.editor.trigger("valuechanged")}return B(document).trigger("selectionchange")};return R})(L);M.Toolbar.addButton(y);v=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.name="italic";S.prototype.icon="italic";S.prototype.htmlTag="i";S.prototype.disableTag="pre";S.prototype.shortcut="cmd+i";S.prototype._init=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + i )"}else{this.title=this.title+" ( Ctrl + i )";this.shortcut="ctrl+i"}return S.__super__._init.call(this)};S.prototype._activeStatus=function(){var T;T=document.queryCommandState("italic")===true;this.setActive(T);return this.active};S.prototype.command=function(){document.execCommand("italic");if(!this.editor.util.support.oninput){this.editor.trigger("valuechanged")}return B(document).trigger("selectionchange")};return S})(L);M.Toolbar.addButton(v);q=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.name="underline";S.prototype.icon="underline";S.prototype.htmlTag="u";S.prototype.disableTag="pre";S.prototype.shortcut="cmd+u";S.prototype.render=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + u )"}else{this.title=this.title+" ( Ctrl + u )";this.shortcut="ctrl+u"}return S.__super__.render.call(this)};S.prototype._activeStatus=function(){var T;T=document.queryCommandState("underline")===true;this.setActive(T);return this.active};S.prototype.command=function(){document.execCommand("underline");if(!this.editor.util.support.oninput){this.editor.trigger("valuechanged")}return B(document).trigger("selectionchange")};return S})(L);M.Toolbar.addButton(q);h=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.name="color";S.prototype.icon="tint";S.prototype.disableTag="pre";S.prototype.menu=true;S.prototype.render=function(){var T;T=1<=arguments.length?n.call(arguments,0):[];return S.__super__.render.apply(this,T)};S.prototype.renderMenu=function(){B('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default"></a></li>\n</ul>').appendTo(this.menuWrapper);this.menuWrapper.on("mousedown",".color-list",function(T){return false});return this.menuWrapper.on("click",".font-color",(function(T){return function(Z){var V,X,Y,U,W,aa;T.wrapper.removeClass("menu-on");V=B(Z.currentTarget);if(V.hasClass("font-color-default")){X=T.editor.body.find("p, li");if(!(X.length>0)){return}W=window.getComputedStyle(X[0],null).getPropertyValue("color");Y=T._convertRgbToHex(W)}else{W=window.getComputedStyle(V[0],null).getPropertyValue("background-color");Y=T._convertRgbToHex(W)}if(!Y){return}U=T.editor.selection.range();if(!V.hasClass("font-color-default")&&U.collapsed){aa=document.createTextNode(T._t("coloredText"));U.insertNode(aa);U.selectNodeContents(aa)}T.editor.selection.range(U);document.execCommand("styleWithCSS",false,true);document.execCommand("foreColor",false,Y);document.execCommand("styleWithCSS",false,false);if(!T.editor.util.support.oninput){return T.editor.trigger("valuechanged")}}})(this))};S.prototype._convertRgbToHex=function(U){var T,V,W;V=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g;T=V.exec(U);if(!T){return""}W=function(Z,Y,X){var aa;aa=function(ac){var ab;ab=ac.toString(16);if(ab.length===1){return"0"+ab}else{return ab}};return"#"+aa(Z)+aa(Y)+aa(X)};return W(T[1]*1,T[2]*1,T[3]*1)};return S})(L);M.Toolbar.addButton(h);D=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.type="";R.prototype.disableTag="pre, table";R.prototype.command=function(W){var T,V,U;V=this.editor.selection.blockNodes();U=this.type==="ul"?"ol":"ul";this.editor.selection.save();T=null;V.each((function(X){return function(Z,aa){var Y;Y=B(aa);if(Y.is("blockquote, li")||Y.is(X.disableTag)||X.editor.util.isDecoratedNode(Y)||!B.contains(document,aa)){return}if(Y.is(X.type)){Y.children("li").each(function(ad,ab){var ac,ae;ae=B(ab);ac=ae.children("ul, ol").insertAfter(Y);return B("<p/>").append(B(ab).html()||X.editor.util.phBr).insertBefore(Y)});return Y.remove()}else{if(Y.is(U)){return B("<"+X.type+"/>").append(Y.contents()).replaceAll(Y)}else{if(T&&Y.prev().is(T)){B("<li/>").append(Y.html()||X.editor.util.phBr).appendTo(T);return Y.remove()}else{T=B("<"+X.type+"><li></li></"+X.type+">");T.find("li").append(Y.html()||X.editor.util.phBr);return T.replaceAll(Y)}}}}})(this));this.editor.selection.restore();return this.editor.trigger("valuechanged")};return R})(L);s=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.type="ol";S.prototype.name="ol";S.prototype.icon="list-ol";S.prototype.htmlTag="ol";S.prototype.shortcut="cmd+/";S.prototype._init=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + / )"}else{this.title=this.title+" ( ctrl + / )";this.shortcut="ctrl+/"}return S.__super__._init.call(this)};return S})(D);G=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.type="ul";R.prototype.name="ul";R.prototype.icon="list-ul";R.prototype.htmlTag="ul";R.prototype.shortcut="cmd+.";R.prototype._init=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + . )"}else{this.title=this.title+" ( Ctrl + . )";this.shortcut="ctrl+."}return R.__super__._init.call(this)};return R})(D);M.Toolbar.addButton(s);M.Toolbar.addButton(G);A=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.name="blockquote";S.prototype.icon="quote-left";S.prototype.htmlTag="blockquote";S.prototype.disableTag="pre, table";S.prototype.command=function(){var U,T,V;U=this.editor.selection.rootNodes();U=U.filter(function(W,X){return !B(X).parent().is("blockquote")});this.editor.selection.save();V=[];T=(function(W){return function(){if(V.length>0){B("<"+W.htmlTag+"/>").insertBefore(V[0]).append(V);return V.length=0}}})(this);U.each((function(W){return function(Y,Z){var X;X=B(Z);if(!X.parent().is(W.editor.body)){return}if(X.is(W.htmlTag)){T();return X.children().unwrap()}else{if(X.is(W.disableTag)||W.editor.util.isDecoratedNode(X)){return T()}else{return V.push(Z)}}}})(this));T();this.editor.selection.restore();return this.editor.trigger("valuechanged")};return S})(L);M.Toolbar.addButton(A);g=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.name="code";S.prototype.icon="code";S.prototype.htmlTag="pre";S.prototype.disableTag="ul, ol, table";S.prototype._init=function(){S.__super__._init.call(this);this.editor.on("decorate",(function(T){return function(V,U){return U.find("pre").each(function(W,X){return T.decorate(B(X))})}})(this));return this.editor.on("undecorate",(function(T){return function(V,U){return U.find("pre").each(function(W,X){return T.undecorate(B(X))})}})(this))};S.prototype.render=function(){var T;T=1<=arguments.length?n.call(arguments,0):[];S.__super__.render.apply(this,T);return this.popover=new r({button:this})};S.prototype._checkMode=function(){var U,T;T=this.editor.selection.range();if((U=B(T.cloneContents()).find(this.editor.util.blockNodes.join(",")))>0||(T.collapsed&&this.editor.selection.startNodes().filter("code").length===0)){this.inlineMode=false;return this.htmlTag="pre"}else{this.inlineMode=true;return this.htmlTag="code"}};S.prototype._status=function(){this._checkMode();S.__super__._status.call(this);if(this.inlineMode){return}if(this.active){return this.popover.show(this.node)}else{return this.popover.hide()}};S.prototype.decorate=function(X){var U,W,V,T;U=X.find("> code");if(U.length>0){W=(V=U.attr("class"))!=null?(T=V.match(/lang-(\S+)/))!=null?T[1]:void 0:void 0;U.contents().unwrap();if(W){return X.attr("data-lang",W)}}};S.prototype.undecorate=function(V){var T,U;U=V.attr("data-lang");T=B("<code/>");if(U&&U!==-1){T.addClass("lang-"+U)}return V.wrapInner(T).removeAttr("data-lang")};S.prototype.command=function(){if(this.inlineMode){return this._inlineCommand()}else{return this._blockCommand()}};S.prototype._blockCommand=function(){var U,T,V,W;U=this.editor.selection.rootNodes();V=[];W=[];T=(function(X){return function(){var Y;if(!(V.length>0)){return}Y=B("<"+X.htmlTag+"/>").insertBefore(V[0]).text(X.editor.formatter.clearHtml(V));W.push(Y[0]);return V.length=0}})(this);U.each((function(X){return function(aa,ab){var Y,Z;Y=B(ab);if(Y.is(X.htmlTag)){T();Z=B("<p/>").append(Y.html().replace("\n","<br/>")).replaceAll(Y);return W.push(Z[0])}else{if(Y.is(X.disableTag)||X.editor.util.isDecoratedNode(Y)||Y.is("blockquote")){return T()}else{return V.push(ab)}}}})(this));T();this.editor.selection.setRangeAtEndOf(B(W).last());return this.editor.trigger("valuechanged")};S.prototype._inlineCommand=function(){var U,V,T;T=this.editor.selection.range();if(this.active){T.selectNodeContents(this.node[0]);this.editor.selection.save(T);this.node.contents().unwrap();this.editor.selection.restore()}else{V=B(T.extractContents());U=B("<"+this.htmlTag+"/>").append(V.contents());T.insertNode(U[0]);T.selectNodeContents(U[0]);this.editor.selection.range(T)}return this.editor.trigger("valuechanged")};return S})(L);r=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.render=function(){var W,U,X,T,V;this._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">'+(this._t("selectLanguage"))+"</option>\n    </select>\n  </div>\n</div>";this.langs=this.editor.opts.codeLanguages||[{name:"Bash",value:"bash"},{name:"C++",value:"c++"},{name:"C#",value:"cs"},{name:"CSS",value:"css"},{name:"Erlang",value:"erlang"},{name:"Less",value:"less"},{name:"Sass",value:"sass"},{name:"Diff",value:"diff"},{name:"CoffeeScript",value:"coffeescript"},{name:"HTML,XML",value:"html"},{name:"JSON",value:"json"},{name:"Java",value:"java"},{name:"JavaScript",value:"js"},{name:"Markdown",value:"markdown"},{name:"Objective C",value:"oc"},{name:"PHP",value:"php"},{name:"Perl",value:"parl"},{name:"Python",value:"python"},{name:"Ruby",value:"ruby"},{name:"SQL",value:"sql"}];this.el.addClass("code-popover").append(this._tpl);this.selectEl=this.el.find(".select-lang");V=this.langs;for(U=0,T=V.length;U<T;U++){X=V[U];W=B("<option/>",{text:X.name,value:X.value}).appendTo(this.selectEl)}this.selectEl.on("change",(function(Y){return function(aa){var Z;Y.lang=Y.selectEl.val();Z=Y.target.hasClass("selected");Y.target.removeClass().removeAttr("data-lang");if(Y.lang!==-1){Y.target.attr("data-lang",Y.lang)}if(Z){Y.target.addClass("selected")}return Y.editor.trigger("valuechanged")}})(this));return this.editor.on("valuechanged",(function(Y){return function(Z){if(Y.active){return Y.refresh()}}})(this))};R.prototype.show=function(){var T;T=1<=arguments.length?n.call(arguments,0):[];R.__super__.show.apply(this,T);this.lang=this.target.attr("data-lang");if(this.lang!=null){return this.selectEl.val(this.lang)}else{return this.selectEl.val(-1)}};return R})(z);M.Toolbar.addButton(g);k=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.name="link";R.prototype.icon="link";R.prototype.htmlTag="a";R.prototype.disableTag="pre";R.prototype.render=function(){var T;T=1<=arguments.length?n.call(arguments,0):[];R.__super__.render.apply(this,T);return this.popover=new K({button:this})};R.prototype._status=function(){R.__super__._status.call(this);if(this.active&&!this.editor.selection.rangeAtEndOf(this.node)){return this.popover.show(this.node)}else{return this.popover.hide()}};R.prototype.command=function(){var W,U,Y,V,T,X;T=this.editor.selection.range();if(this.active){X=document.createTextNode(this.node.text());this.node.replaceWith(X);T.selectNode(X)}else{W=B(T.extractContents());V=this.editor.formatter.clearHtml(W.contents(),false);U=B("<a/>",{href:"",target:"_blank",text:V||this._t("linkText")});if(this.editor.selection.blockNodes().length>0){T.insertNode(U[0])}else{Y=B("<p/>").append(U);T.insertNode(Y[0])}T.selectNodeContents(U[0]);this.popover.one("popovershow",(function(Z){return function(){if(V){Z.popover.urlEl.focus();return Z.popover.urlEl[0].select()}else{Z.popover.textEl.focus();return Z.popover.textEl[0].select()}}})(this))}this.editor.selection.range(T);return this.editor.trigger("valuechanged")};return R})(L);K=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.render=function(){var T;T='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+(this._t("linkText"))+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+(this._t("removeLink"))+'"\n      tabindex="-1">\n      <span class="simditor-icon simditor-icon-unlink"></span>\n    </a>\n  </div>\n  <div class="settings-field">\n    <label>'+(this._t("linkUrl"))+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n  <div class="settings-field">\n    <label>'+(this._t("linkTarget"))+'</label>\n    <select class="link-target">\n      <option value="_blank">'+(this._t("openLinkInNewWindow"))+' (_blank)</option>\n      <option value="_self">'+(this._t("openLinkInCurrentWindow"))+" (_self)</option>\n    </select>\n  </div>\n</div>";this.el.addClass("link-popover").append(T);this.textEl=this.el.find(".link-text");this.urlEl=this.el.find(".link-url");this.unlinkEl=this.el.find(".btn-unlink");this.selectTarget=this.el.find(".link-target");this.textEl.on("keyup",(function(U){return function(V){if(V.which===13){return}U.target.text(U.textEl.val());return U.editor.inputManager.throttledValueChanged()}})(this));this.urlEl.on("keyup",(function(U){return function(V){var W;if(V.which===13){return}W=U.urlEl.val();if(!(/^(http|https|ftp|ftps|file)?:\/\/|^(mailto|tel)?:|^\//ig.test(W)||!W)){W="http://"+W}U.target.attr("href",W);return U.editor.inputManager.throttledValueChanged()}})(this));B([this.urlEl[0],this.textEl[0]]).on("keydown",(function(U){return function(W){var V;if(W.which===13||W.which===27||(!W.shiftKey&&W.which===9&&B(W.target).hasClass("link-url"))){W.preventDefault();V=document.createRange();U.editor.selection.setRangeAfter(U.target,V);U.hide();return U.editor.inputManager.throttledValueChanged()}}})(this));this.unlinkEl.on("click",(function(U){return function(X){var V,W;W=document.createTextNode(U.target.text());U.target.replaceWith(W);U.hide();V=document.createRange();U.editor.selection.setRangeAfter(W,V);return U.editor.inputManager.throttledValueChanged()}})(this));return this.selectTarget.on("change",(function(U){return function(V){U.target.attr("target",U.selectTarget.val());return U.editor.inputManager.throttledValueChanged()}})(this))};S.prototype.show=function(){var T;T=1<=arguments.length?n.call(arguments,0):[];S.__super__.show.apply(this,T);this.textEl.val(this.target.text());return this.urlEl.val(this.target.attr("href"))};return S})(z);M.Toolbar.addButton(k);Q=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.name="image";S.prototype.icon="picture-o";S.prototype.htmlTag="img";S.prototype.disableTag="pre, table";S.prototype.defaultImage="";S.prototype.needFocus=false;S.prototype._init=function(){var W,U,T,V;if(this.editor.opts.imageButton){if(Array.isArray(this.editor.opts.imageButton)){this.menu=[];V=this.editor.opts.imageButton;for(U=0,T=V.length;U<T;U++){W=V[U];this.menu.push({name:W+"-image",text:this._t(W+"Image")})}}else{this.menu=false}}else{if(this.editor.uploader!=null){this.menu=[{name:"upload-image",text:this._t("uploadImage")},{name:"external-image",text:this._t("externalImage")}]}else{this.menu=false}}this.defaultImage=this.editor.opts.defaultImage;this.editor.body.on("click","img:not([data-non-image])",(function(X){return function(aa){var Z,Y;Z=B(aa.currentTarget);Y=document.createRange();Y.selectNode(Z[0]);X.editor.selection.range(Y);if(!X.editor.util.support.onselectionchange){X.editor.trigger("selectionchanged")}return false}})(this));this.editor.body.on("mouseup","img:not([data-non-image])",function(X){return false});this.editor.on("selectionchanged.image",(function(X){return function(){var aa,Z,Y;Y=X.editor.selection.range();if(Y==null){return}aa=B(Y.cloneContents()).contents();if(aa.length===1&&aa.is("img:not([data-non-image])")){Z=B(Y.startContainer).contents().eq(Y.startOffset);return X.popover.show(Z)}else{return X.popover.hide()}}})(this));this.editor.on("valuechanged.image",(function(X){return function(){var Y;Y=X.editor.wrapper.find(".simditor-image-loading");if(!(Y.length>0)){return}return Y.each(function(ac,Z){var ab,ad,aa;ad=B(Z);ab=ad.data("img");if(!(ab&&ab.parent().length>0)){ad.remove();if(ab){aa=ab.data("file");if(aa){X.editor.uploader.cancel(aa);if(X.editor.body.find("img.uploading").length<1){return X.editor.uploader.trigger("uploadready",[aa])}}}}})}})(this));return S.__super__._init.call(this)};S.prototype.render=function(){var T;T=1<=arguments.length?n.call(arguments,0):[];S.__super__.render.apply(this,T);this.popover=new u({button:this});if(this.editor.opts.imageButton==="upload"){return this._initUploader(this.el)}};S.prototype.renderMenu=function(){S.__super__.renderMenu.call(this);return this._initUploader()};S.prototype._initUploader=function(U){var W,T,V;if(U==null){U=this.menuEl.find(".menu-item-upload-image")}if(this.editor.uploader==null){this.el.find(".btn-upload").remove();return}W=null;T=(function(X){return function(){if(W){W.remove()}return W=B("<input/>",{type:"file",title:X._t("uploadImage"),multiple:true,accept:"image/gif,image/jpeg,image/jpg,image/png,image/svg"}).appendTo(U)}})(this);T();U.on("click mousedown","input[type=file]",function(X){return X.stopPropagation()});U.on("change","input[type=file]",(function(X){return function(Y){if(X.editor.inputManager.focused){X.editor.uploader.upload(W,{inline:true});T()}else{X.editor.one("focus",function(Z){X.editor.uploader.upload(W,{inline:true});return T()});X.editor.focus()}return X.wrapper.removeClass("menu-on")}})(this));this.editor.uploader.on("beforeupload",(function(X){return function(aa,Z){var Y;if(!Z.inline){return}if(Z.img){Y=B(Z.img)}else{Y=X.createImage(Z.name);Z.img=Y}Y.addClass("uploading");Y.data("file",Z);return X.editor.uploader.readImageFile(Z.obj,function(ab){var ac;if(!Y.hasClass("uploading")){return}ac=ab?ab.src:X.defaultImage;return X.loadImage(Y,ac,function(){if(X.popover.active){X.popover.refresh();return X.popover.srcEl.val(X._t("uploading")).prop("disabled",true)}})})}})(this));V=B.proxy(this.editor.util.throttle(function(ad,Z,X,ab){var Y,ac,aa;if(!Z.inline){return}ac=Z.img.data("mask");if(!ac){return}Y=ac.data("img");if(!(Y&&Y.hasClass("uploading")&&Y.parent().length>0)){ac.remove();return}aa=X/ab;aa=(aa*100).toFixed(0);if(aa>99){aa=99}return ac.find(".progress").height((100-aa)+"%")},500),this);this.editor.uploader.on("uploadprogress",V);this.editor.uploader.on("uploadsuccess",(function(X){return function(ac,aa,Y){var Z,ab,ae;if(!aa.inline){return}Z=aa.img;if(!(Z.hasClass("uploading")&&Z.parent().length>0)){return}if(typeof Y!=="object"){try{Y=B.parseJSON(Y)}catch(ad){ac=ad;Y={success:false}}}if(Y.success===false){ae=Y.msg||X._t("uploadFailed");alert(ae);ab=X.defaultImage}else{ab=Y.file_path}X.loadImage(Z,ab,function(){var af;Z.removeData("file");Z.removeClass("uploading").removeClass("loading");af=Z.data("mask");if(af){af.remove()}Z.removeData("mask");X.editor.trigger("valuechanged");if(X.editor.body.find("img.uploading").length<1){return X.editor.uploader.trigger("uploadready",[aa,Y])}});if(X.popover.active){X.popover.srcEl.prop("disabled",false);return X.popover.srcEl.val(Y.file_path)}}})(this));return this.editor.uploader.on("uploaderror",(function(X){return function(ab,aa,ae){var Z,ad,Y;if(!aa.inline){return}if(ae.statusText==="abort"){return}if(ae.responseText){try{Y=B.parseJSON(ae.responseText);ad=Y.msg}catch(ac){ab=ac;ad=X._t("uploadError")}}Z=aa.img;if(!(Z.hasClass("uploading")&&Z.parent().length>0)){return}X.loadImage(Z,X.defaultImage,function(){var af;Z.removeData("file");Z.removeClass("uploading").removeClass("loading");af=Z.data("mask");if(af){af.remove()}return Z.removeData("mask")});if(X.popover.active){X.popover.srcEl.prop("disabled",false);X.popover.srcEl.val(X.defaultImage)}X.editor.trigger("valuechanged");if(X.editor.body.find("img.uploading").length<1){return X.editor.uploader.trigger("uploadready",[aa,Y])}}})(this))};S.prototype._status=function(){return this._disableStatus()};S.prototype.loadImage=function(U,X,Y){var W,T,V;V=(function(Z){return function(){var ab,aa;ab=U.offset();aa=Z.editor.wrapper.offset();return W.css({top:ab.top-aa.top,left:ab.left-aa.left,width:U.width(),height:U.height()}).show()}})(this);U.addClass("loading");W=U.data("mask");if(!W){W=B('<div class="simditor-image-loading">\n  <div class="progress"></div>\n</div>').hide().appendTo(this.editor.wrapper);V();U.data("mask",W);W.data("img",U)}T=new Image();T.onload=(function(Z){return function(){var aa,ab;if(!U.hasClass("loading")&&!U.hasClass("uploading")){return}ab=T.width;aa=T.height;U.attr({src:X,width:ab,height:aa,"data-image-size":ab+","+aa}).removeClass("loading");if(U.hasClass("uploading")){Z.editor.util.reflow(Z.editor.body);V()}else{W.remove();U.removeData("mask")}if(B.isFunction(Y)){return Y(T)}}})(this);T.onerror=function(){if(B.isFunction(Y)){Y(false)}W.remove();return U.removeData("mask").removeClass("loading")};return T.setAttribute("src",X)};S.prototype.createImage=function(U){var V,T;if(U==null){U="Image"}if(!this.editor.inputManager.focused){this.editor.focus()}T=this.editor.selection.range();T.deleteContents();this.editor.selection.range(T);V=B("<img/>").attr("alt",U).attr("src",this.defaultImage);T.insertNode(V[0]);this.editor.selection.setRangeAfter(V,T);this.editor.trigger("valuechanged");return V};S.prototype.command=function(U){var T;T=this.createImage();return this.loadImage(T,U||this.defaultImage,(function(V){return function(){V.editor.trigger("valuechanged");V.editor.util.reflow(T);T.click();return V.popover.one("popovershow",function(){V.popover.srcEl.focus();return V.popover.srcEl[0].select()})}})(this))};return S})(L);u=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.offset={top:6,left:-4};R.prototype.render=function(){var T;T='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+(this._t("imageUrl"))+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;"\n      title="'+(this._t("uploadImage"))+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-upload"></span>\n    </a>\n  </div>\n  <div class=\'settings-field\'>\n    <label>'+(this._t("imageAlt"))+'</label>\n    <input class="image-alt" id="image-alt" type="text" tabindex="1" />\n  </div>\n  <div class="settings-field">\n    <label>'+(this._t("imageSize"))+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">×</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;"\n      title="'+(this._t("restoreImageSize"))+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-undo"></span>\n    </a>\n  </div>\n</div>';this.el.addClass("image-popover").append(T);this.srcEl=this.el.find(".image-src");this.widthEl=this.el.find("#image-width");this.heightEl=this.el.find("#image-height");this.altEl=this.el.find("#image-alt");this.srcEl.on("keydown",(function(U){return function(W){var V;if(!(W.which===13&&!U.target.hasClass("uploading"))){return}W.preventDefault();V=document.createRange();U.button.editor.selection.setRangeAfter(U.target,V);return U.hide()}})(this));this.srcEl.on("blur",(function(U){return function(V){return U._loadImage(U.srcEl.val())}})(this));this.el.find(".image-size").on("blur",(function(U){return function(V){U._resizeImg(B(V.currentTarget));return U.el.data("popover").refresh()}})(this));this.el.find(".image-size").on("keyup",(function(U){return function(W){var V;V=B(W.currentTarget);if(!(W.which===13||W.which===27||W.which===9)){return U._resizeImg(V,true)}}})(this));this.el.find(".image-size").on("keydown",(function(U){return function(Y){var W,X,V;X=B(Y.currentTarget);if(Y.which===13||Y.which===27){Y.preventDefault();if(Y.which===13){U._resizeImg(X)}else{U._restoreImg()}W=U.target;U.hide();V=document.createRange();return U.button.editor.selection.setRangeAfter(W,V)}else{if(Y.which===9){return U.el.data("popover").refresh()}}}})(this));this.altEl.on("keydown",(function(U){return function(W){var V;if(W.which===13){W.preventDefault();V=document.createRange();U.button.editor.selection.setRangeAfter(U.target,V);return U.hide()}}})(this));this.altEl.on("keyup",(function(U){return function(V){if(V.which===13||V.which===27||V.which===9){return}U.alt=U.altEl.val();return U.target.attr("alt",U.alt)}})(this));this.el.find(".btn-restore").on("click",(function(U){return function(V){U._restoreImg();return U.el.data("popover").refresh()}})(this));this.editor.on("valuechanged",(function(U){return function(V){if(U.active){return U.refresh()}}})(this));return this._initUploader()};R.prototype._initUploader=function(){var T,U;T=this.el.find(".btn-upload");if(this.editor.uploader==null){T.remove();return}U=(function(V){return function(){if(V.input){V.input.remove()}return V.input=B("<input/>",{type:"file",title:V._t("uploadImage"),multiple:true,accept:"image/gif,image/jpeg,image/jpg,image/png,image/svg"}).appendTo(T)}})(this);U();this.el.on("click mousedown","input[type=file]",function(V){return V.stopPropagation()});return this.el.on("change","input[type=file]",(function(V){return function(W){V.editor.uploader.upload(V.input,{inline:true,img:V.target});return U()}})(this))};R.prototype._resizeImg=function(X,U){var T,W,V;if(U==null){U=false}W=X.val()*1;if(!(this.target&&(B.isNumeric(W)||W<0))){return}if(X.is(this.widthEl)){V=W;T=this.height*W/this.width;this.heightEl.val(T)}else{T=W;V=this.width*W/this.height;this.widthEl.val(V)}if(!U){this.target.attr({width:V,height:T});return this.editor.trigger("valuechanged")}};R.prototype._restoreImg=function(){var U,T;T=((U=this.target.data("image-size"))!=null?U.split(","):void 0)||[this.width,this.height];this.target.attr({width:T[0]*1,height:T[1]*1});this.widthEl.val(T[0]);this.heightEl.val(T[1]);return this.editor.trigger("valuechanged")};R.prototype._loadImage=function(T,U){if(/^data:image/.test(T)&&!this.editor.uploader){if(U){U(false)}return}if(this.target.attr("src")===T){return}return this.button.loadImage(this.target,T,(function(V){return function(X){var W;if(!X){return}if(V.active){V.width=X.width;V.height=X.height;V.widthEl.val(V.width);V.heightEl.val(V.height)}if(/^data:image/.test(T)){W=V.editor.util.dataURLtoBlob(T);W.name="Base64 Image.png";V.editor.uploader.upload(W,{inline:true,img:V.target})}else{V.editor.trigger("valuechanged")}if(U){return U(X)}}})(this))};R.prototype.show=function(){var U,T;T=1<=arguments.length?n.call(arguments,0):[];R.__super__.show.apply(this,T);U=this.target;this.width=U.width();this.height=U.height();this.alt=U.attr("alt");if(U.hasClass("uploading")){return this.srcEl.val(this._t("uploading")).prop("disabled",true)}else{this.srcEl.val(U.attr("src")).prop("disabled",false);this.widthEl.val(this.width);this.heightEl.val(this.height);return this.altEl.val(this.alt)}};return R})(z);M.Toolbar.addButton(Q);O=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.name="indent";R.prototype.icon="indent";R.prototype._init=function(){var T;T=this.editor.opts.tabIndent===false?"":" (Tab)";this.title=this._t(this.name)+T;return R.__super__._init.call(this)};R.prototype._status=function(){};R.prototype.command=function(){return this.editor.indentation.indent()};return R})(L);M.Toolbar.addButton(O);C=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.name="outdent";S.prototype.icon="outdent";S.prototype._init=function(){var T;T=this.editor.opts.tabIndent===false?"":" (Shift + Tab)";this.title=this._t(this.name)+T;return S.__super__._init.call(this)};S.prototype._status=function(){};S.prototype.command=function(){return this.editor.indentation.indent(true)};return S})(L);M.Toolbar.addButton(C);J=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.name="hr";R.prototype.icon="minus";R.prototype.htmlTag="hr";R.prototype._status=function(){};R.prototype.command=function(){var V,W,T,U;U=this.editor.selection.rootNodes().first();T=U.next();if(T.length>0){this.editor.selection.save()}else{W=B("<p/>").append(this.editor.util.phBr)}V=B("<hr/>").insertAfter(U);if(W){W.insertAfter(V);this.editor.selection.setRangeAtStartOf(W)}else{this.editor.selection.restore()}return this.editor.trigger("valuechanged")};return R})(L);M.Toolbar.addButton(J);f=(function(R){l(S,R);function S(){return S.__super__.constructor.apply(this,arguments)}S.prototype.name="table";S.prototype.icon="table";S.prototype.htmlTag="table";S.prototype.disableTag="pre, li, blockquote";S.prototype.menu=true;S.prototype._init=function(){S.__super__._init.call(this);B.merge(this.editor.formatter._allowedTags,["thead","th","tbody","tr","td","colgroup","col"]);B.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]});B.extend(this.editor.formatter._allowedStyles,{td:["text-align"],th:["text-align"]});this._initShortcuts();this._initResize();this.editor.on("decorate",(function(T){return function(V,U){return U.find("table").each(function(W,X){return T.decorate(B(X))})}})(this));this.editor.on("undecorate",(function(T){return function(V,U){return U.find("table").each(function(W,X){return T.undecorate(B(X))})}})(this));this.editor.on("selectionchanged.table",(function(T){return function(V){var W,U;T.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active");U=T.editor.selection.range();if(!U){return}W=T.editor.selection.containerNode();if(U.collapsed&&W.is(".simditor-table")){T.editor.selection.setRangeAtEndOf(W)}return W.closest("td, th",T.editor.body).addClass("active")}})(this));this.editor.on("blur.table",(function(T){return function(U){return T.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active")}})(this));this.editor.keystroke.add("up","td",(function(T){return function(V,U){T._tdNav(U,"up");return true}})(this));this.editor.keystroke.add("up","th",(function(T){return function(V,U){T._tdNav(U,"up");return true}})(this));this.editor.keystroke.add("down","td",(function(T){return function(V,U){T._tdNav(U,"down");return true}})(this));return this.editor.keystroke.add("down","th",(function(T){return function(V,U){T._tdNav(U,"down");return true}})(this))};S.prototype._tdNav=function(T,Z){var ab,W,V,Y,X,aa,U;if(Z==null){Z="up"}V=Z==="up"?"prev":"next";U=Z==="up"?["tbody","thead"]:["thead","tbody"],aa=U[0],Y=U[1];W=T.parent("tr");ab=this["_"+V+"Row"](W);if(!(ab.length>0)){return true}X=W.find("td, th").index(T);return this.editor.selection.setRangeAtEndOf(ab.find("td, th").eq(X))};S.prototype._nextRow=function(U){var T;T=U.next("tr");if(T.length<1&&U.parent("thead").length>0){T=U.parent("thead").next("tbody").find("tr:first")}return T};S.prototype._prevRow=function(T){var U;U=T.prev("tr");if(U.length<1&&T.parent("tbody").length>0){U=T.parent("tbody").prev("thead").find("tr")}return U};S.prototype._initResize=function(){var T;T=this.editor;B(document).on("mousemove.simditor-table",".simditor-table td, .simditor-table th",function(aa){var ad,U,ab,V,X,Y,W,Z,ac;X=B(this).parents(".simditor-table");ab=X.find(".simditor-resize-handle");U=X.find("colgroup");if(X.hasClass("resizing")){return}V=B(aa.currentTarget);ac=aa.pageX-B(aa.currentTarget).offset().left;if(ac<5&&V.prev().length>0){V=V.prev()}if(V.next("td, th").length<1){ab.hide();return}if((W=ab.data("td"))!=null?W.is(V):void 0){ab.show();return}Y=V.parent().find("td, th").index(V);ad=U.find("col").eq(Y);if((Z=ab.data("col"))!=null?Z.is(ad):void 0){ab.show();return}return ab.css("left",V.position().left+V.outerWidth()-5).data("td",V).data("col",ad).show()});B(document).on("mouseleave.simditor-table",".simditor-table",function(U){return B(this).find(".simditor-resize-handle").hide()});return B(document).on("mousedown.simditor-resize-handle",".simditor-resize-handle",function(ad){var X,Y,ag,ae,V,ac,U,W,aa,af,Z,ab;ac=B(this).parent(".simditor-table");X=B(ad.currentTarget);ag=X.data("td");Y=X.data("col");V=ag.next("td, th");ae=Y.next("col");Z=ad.pageX;aa=ag.outerWidth()*1;af=V.outerWidth()*1;W=parseFloat(X.css("left"));ab=ag.closest("table").width();U=50;B(document).on("mousemove.simditor-resize-table",function(aj){var ah,ai,ak;ah=aj.pageX-Z;ai=aa+ah;ak=af-ah;if(ai<U){ai=U;ah=U-aa;ak=af-ah}else{if(ak<U){ak=U;ah=af-U;ai=aa+ah}}Y.attr("width",(ai/ab*100)+"%");ae.attr("width",(ak/ab*100)+"%");return X.css("left",W+ah)});B(document).one("mouseup.simditor-resize-table",function(ah){T.sync();B(document).off(".simditor-resize-table");return ac.removeClass("resizing")});ac.addClass("resizing");return false})};S.prototype._initShortcuts=function(){this.editor.hotkeys.add("ctrl+alt+up",(function(T){return function(U){T.editMenu.find(".menu-item[data-param=insertRowAbove]").click();return false}})(this));this.editor.hotkeys.add("ctrl+alt+down",(function(T){return function(U){T.editMenu.find(".menu-item[data-param=insertRowBelow]").click();return false}})(this));this.editor.hotkeys.add("ctrl+alt+left",(function(T){return function(U){T.editMenu.find(".menu-item[data-param=insertColLeft]").click();return false}})(this));return this.editor.hotkeys.add("ctrl+alt+right",(function(T){return function(U){T.editMenu.find(".menu-item[data-param=insertColRight]").click();return false}})(this))};S.prototype.decorate=function(V){var U,Y,X,T,W,Z;if(V.parent(".simditor-table").length>0){this.undecorate(V)}V.wrap('<div class="simditor-table"></div>');Z=V.parent(".simditor-table");U=V.find("colgroup");if(V.find("thead").length<1){W=B("<thead />");Y=V.find("tr").first();W.append(Y);this._changeCellTag(Y,"th");T=V.find("tbody");if(T.length>0){T.before(W)}else{V.prepend(W)}}if(U.length<1){U=B("<colgroup/>").prependTo(V);V.find("thead tr th").each(function(aa,ac){var ab;return ab=B("<col/>").appendTo(U)});this.refreshTableWidth(V)}X=B("<div />",{"class":"simditor-resize-handle",contenteditable:"false"}).appendTo(Z);return V.parent()};S.prototype.undecorate=function(T){if(!(T.parent(".simditor-table").length>0)){return}return T.parent().replaceWith(T)};S.prototype.renderMenu=function(){var T;B('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteRow">\n        <span>'+(this._t("deleteRow"))+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowAbove">\n        <span>'+(this._t("insertRowAbove"))+' ( Ctrl + Alt + ↑ )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowBelow">\n        <span>'+(this._t("insertRowBelow"))+' ( Ctrl + Alt + ↓ )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteCol">\n        <span>'+(this._t("deleteColumn"))+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColLeft">\n        <span>'+(this._t("insertColumnLeft"))+' ( Ctrl + Alt + ← )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColRight">\n        <span>'+(this._t("insertColumnRight"))+' ( Ctrl + Alt + → )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteTable">\n        <span>'+(this._t("deleteTable"))+"</span>\n      </a>\n    </li>\n  </ul>\n</div>").appendTo(this.menuWrapper);this.createMenu=this.menuWrapper.find(".menu-create-table");this.editMenu=this.menuWrapper.find(".menu-edit-table");T=this.createTable(6,6).appendTo(this.createMenu);this.createMenu.on("mouseenter","td, th",(function(U){return function(Y){var Z,X,V,W;U.createMenu.find("td, th").removeClass("selected");Z=B(Y.currentTarget);X=Z.parent();W=X.find("td, th").index(Z)+1;V=X.prevAll("tr").addBack();if(X.parent().is("tbody")){V=V.add(T.find("thead tr"))}return V.find("td:lt("+W+"), th:lt("+W+")").addClass("selected")}})(this));this.createMenu.on("mouseleave",function(U){return B(U.currentTarget).find("td, th").removeClass("selected")});return this.createMenu.on("mousedown","td, th",(function(U){return function(X){var aa,Z,W,V,Y;U.wrapper.removeClass("menu-on");if(!U.editor.inputManager.focused){return}Z=B(X.currentTarget);W=Z.parent();V=W.find("td").index(Z)+1;Y=W.prevAll("tr").length+1;if(W.parent().is("tbody")){Y+=1}T=U.createTable(Y,V,true);aa=U.editor.selection.blockNodes().last();if(U.editor.util.isEmptyNode(aa)){aa.replaceWith(T)}else{aa.after(T)}U.decorate(T);U.editor.selection.setRangeAtStartOf(T.find("th:first"));U.editor.trigger("valuechanged");return false}})(this))};S.prototype.createTable=function(ag,W,aa){var af,Z,U,ad,ab,ae,Y,X,T,V,ac;af=B("<table/>");ad=B("<thead/>").appendTo(af);Z=B("<tbody/>").appendTo(af);for(T=Y=0,V=ag;0<=V?Y<V:Y>V;T=0<=V?++Y:--Y){ab=B("<tr/>");ab.appendTo(T===0?ad:Z);for(ae=X=0,ac=W;0<=ac?X<ac:X>ac;ae=0<=ac?++X:--X){U=B(T===0?"<th/>":"<td/>").appendTo(ab);if(aa){U.append(this.editor.util.phBr)}}}return af};S.prototype.refreshTableWidth=function(T){return setTimeout((function(U){return function(){var W,V;V=T.width();W=T.find("col");return T.find("thead tr th").each(function(X,Z){var Y;Y=W.eq(X);return Y.attr("width",(B(Z).outerWidth()/V*100)+"%")})}})(this),0)};S.prototype.setActive=function(T){S.__super__.setActive.call(this,T);if(T){this.createMenu.hide();return this.editMenu.show()}else{this.createMenu.show();return this.editMenu.hide()}};S.prototype._changeCellTag=function(U,T){return U.find("td, th").each(function(W,V){var X;X=B(V);return X.replaceWith("<"+T+">"+(X.html())+"</"+T+">")})};S.prototype.deleteRow=function(W){var V,U,T;U=W.parent("tr");if(U.closest("table").find("tr").length<1){return this.deleteTable(W)}else{V=this._nextRow(U);if(!(V.length>0)){V=this._prevRow(U)}T=U.find("td, th").index(W);if(U.parent().is("thead")){V.appendTo(U.parent());this._changeCellTag(V,"th")}U.remove();return this.editor.selection.setRangeAtEndOf(V.find("td, th").eq(T))}};S.prototype.insertRow=function(U,ac){var ab,ad,Z,W,T,Y,aa,X,V;if(ac==null){ac="after"}Z=U.parent("tr");ad=Z.closest("table");T=0;ad.find("tr").each(function(ae,af){return T=Math.max(T,B(af).find("td").length)});aa=Z.find("td, th").index(U);ab=B("<tr/>");W="td";if(ac==="after"&&Z.parent().is("thead")){Z.parent().next("tbody").prepend(ab)}else{if(ac==="before"&&Z.parent().is("thead")){Z.before(ab);Z.parent().next("tbody").prepend(Z);this._changeCellTag(Z,"td");W="th"}else{Z[ac](ab)}}for(Y=X=1,V=T;1<=V?X<=V:X>=V;Y=1<=V?++X:--X){B("<"+W+"/>").append(this.editor.util.phBr).appendTo(ab)}return this.editor.selection.setRangeAtStartOf(ab.find("td, th").eq(aa))};S.prototype.deleteCol=function(Y){var T,V,X,U,Z,W;X=Y.parent("tr");W=X.closest("table").find("tr").length<2;Z=Y.siblings("td, th").length<1;if(W&&Z){return this.deleteTable(Y)}else{U=X.find("td, th").index(Y);T=Y.next("td, th");if(!(T.length>0)){T=X.prev("td, th")}V=X.closest("table");V.find("col").eq(U).remove();V.find("tr").each(function(aa,ab){return B(ab).find("td, th").eq(U).remove()});this.refreshTableWidth(V);return this.editor.selection.setRangeAtEndOf(T)}};S.prototype.insertCol=function(U,aa){var ab,Z,V,ac,W,Y,X,T;if(aa==null){aa="after"}W=U.parent("tr");Y=W.find("td, th").index(U);ac=U.closest("table");ab=ac.find("col").eq(Y);ac.find("tr").each((function(ad){return function(af,ah){var ae,ag;ag=B(ah).parent().is("thead")?"th":"td";ae=B("<"+ag+"/>").append(ad.editor.util.phBr);return B(ah).find("td, th").eq(Y)[aa](ae)}})(this));Z=B("<col/>");ab[aa](Z);X=ac.width();T=Math.max(parseFloat(ab.attr("width"))/2,50/X*100);ab.attr("width",T+"%");Z.attr("width",T+"%");this.refreshTableWidth(ac);V=aa==="after"?U.next("td, th"):U.prev("td, th");return this.editor.selection.setRangeAtStartOf(V)};S.prototype.deleteTable=function(V){var U,T;T=V.closest(".simditor-table");U=T.next("p");T.remove();if(U.length>0){return this.editor.selection.setRangeAtStartOf(U)}};S.prototype.command=function(U){var T;T=this.editor.selection.containerNode().closest("td, th");if(!(T.length>0)){return}if(U==="deleteRow"){this.deleteRow(T)}else{if(U==="insertRowAbove"){this.insertRow(T,"before")}else{if(U==="insertRowBelow"){this.insertRow(T)}else{if(U==="deleteCol"){this.deleteCol(T)}else{if(U==="insertColLeft"){this.insertCol(T,"before")}else{if(U==="insertColRight"){this.insertCol(T)}else{if(U==="deleteTable"){this.deleteTable(T)}else{return}}}}}}}return this.editor.trigger("valuechanged")};return S})(L);M.Toolbar.addButton(f);I=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.name="strikethrough";R.prototype.icon="strikethrough";R.prototype.htmlTag="strike";R.prototype.disableTag="pre";R.prototype._activeStatus=function(){var T;T=document.queryCommandState("strikethrough")===true;this.setActive(T);return this.active};R.prototype.command=function(){document.execCommand("strikethrough");if(!this.editor.util.support.oninput){this.editor.trigger("valuechanged")}return B(document).trigger("selectionchange")};return R})(L);M.Toolbar.addButton(I);c=(function(S){l(R,S);function R(){return R.__super__.constructor.apply(this,arguments)}R.prototype.name="alignment";R.prototype.icon="align-left";R.prototype.htmlTag="p, h1, h2, h3, h4, td, th";R.prototype._init=function(){this.menu=[{name:"left",text:this._t("alignLeft"),icon:"align-left",param:"left"},{name:"center",text:this._t("alignCenter"),icon:"align-center",param:"center"},{name:"right",text:this._t("alignRight"),icon:"align-right",param:"right"}];return R.__super__._init.call(this)};R.prototype.setActive=function(T,U){if(U==null){U="left"}if(U!=="left"&&U!=="center"&&U!=="right"){U="left"}if(U==="left"){R.__super__.setActive.call(this,false)}else{R.__super__.setActive.call(this,T)}this.el.removeClass("align-left align-center align-right");if(T){this.el.addClass("align-"+U)}this.setIcon("align-"+U);return this.menuEl.find(".menu-item").show().end().find(".menu-item-"+U).hide()};R.prototype._status=function(){this.nodes=this.editor.selection.nodes().filter(this.htmlTag);if(this.nodes.length<1){this.setDisabled(true);return this.setActive(false)}else{this.setDisabled(false);return this.setActive(true,this.nodes.first().css("text-align"))}};R.prototype.command=function(T){if(T!=="left"&&T!=="center"&&T!=="right"){throw new Error("simditor alignment button: invalid align "+T)}this.nodes.css({"text-align":T==="left"?"":T});this.editor.trigger("valuechanged");return this.editor.inputManager.throttledSelectionChanged()};return R})(L);M.Toolbar.addButton(c);return M}));